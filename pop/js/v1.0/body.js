Array.prototype.clear=function(){this.length=0};Array.prototype.each=function(c,b){b=b||this;for(var a=0;a<this.length;a++){if(c.call(b||this[a],a,this[a])===false){break}}};String.prototype.url=function(){var a=new RegExp("[a-zA-z]+://[^s]*");return this.length==0?"javascript:void(0)":a.test(this)?this:"http://"+this};Date.prototype.Format=function(f){f=f||"m-d H:i:s";var arr=[];for(var i=0;i<f.length;i++){arr.push(Date.getFormatCode(f.charAt(i)))}arr.push("''");return eval(arr.join(""))};Date.getFormatCode=function(a){switch(a){case"Y":return"this.getFullYear() + ";case"m":return"String.leftPad(this.getMonth(), 2, '0') + ";case"d":return"String.leftPad(this.getDate(), 2, '0') + ";case"H":return"String.leftPad(this.getHours(), 2, '0') + ";case"i":return"String.leftPad(this.getMinutes(), 2, '0') + ";case"s":return"String.leftPad(this.getSeconds(), 2, '0') + ";default:return"'"+a+"'+"}};var W=WIM={};$.extend(WIM,{util:{},UI:{},Menu:{},Bubble:{},Text:{},T:{},Win:{},_urlRecv:"ezchat/poll",_urlSend:"post/ezchat",_secret:"",_service:null,_me:null,_Website:"",_urlFrame:"comet.html",Apply:jQuery.extend,json:function(c){var b=[];for(var a in c){if(typeof c[a]!="object"&&typeof c[a]!="function"){if(typeof c[a]=="string"){b.push('"'+a+'":"'+c[a].valueOf()+'"')}else{b.push('"'+a+'":'+c[a].valueOf())}}}return"{"+b.join(",")+"}"},chatWindow:null,chatWindowUrl:"chatWindow.html",loginWindowUrl:"loginWindow.html",regWindowUrl:"regWindow.html",reload:function(){window.location.replace("puzzle.html?referer="+document.referrer+"&theme="+window.theme)}});window.getWIM=function(){return g.isWin?window.WIM:self.opener?self.opener.WIM:window.WIM};WIM.Text={Add:"Add",New:"New",Cancel:"Cansel",OK:"OK",Success:"Success"};WIM.Tool=Base.extend({constructor:function(a){$.extend(this,{hide:false,logon:false,useable:false});WIM.Apply(this,a)},getId:function(){return"_"+this.id},isDefault:function(){return this.id==WIM.Tool.DEFAULT},hasRight:function(){return !this.isDefault()&&this.useable===true},update:function(a){$.extend(this,a)}});WIM.ToolMgr=function(){return{tools:{},add:function(a){for(var b=0;b<arguments.length;b++){one=arguments[b];if(one.constructor==WIM.Tool){this.tools[one.id]=one}else{arguments.callee.call(this,new WIM.Tool(one))}}},del:function(a){delete this.tools[a]},get:function(a){return this.tools[a]||{}},each:function(b,a){$.each(this.tools,function(c,d){return b.call(a||d,c,d)})}}}();WIM.ToolMgr.add({id:WIM.Tool.DEFAULT=0,prot:0,logon:true,name:"EZChat",iconCls:"wim-tool-EZOnline",iconClsOff:"wim-tool-EZOffline",desc:"hope"},{id:WIM.Tool.MSN=1,prot:1,name:"MSN",iconCls:"wim-tool-MSNOnline",iconClsOff:"wim-tool-MSNOffline",desc:"MSN"},{id:WIM.Tool.Gtalk=3,prot:3,name:"GTalk",iconCls:"tool-gtalkOn",iconClsOff:"tool-gtalkOff",desc:"Google IM tool"});WIM.Profile=Base.extend({constructor:function(a){$.extend(this,{blog:""});WIM.Apply(this,a)},update:function(a){WIM.Apply(this,a)},getBlog:function(){return this.blog||""},getName:function(){return(WIM.Profile.alias?this.remark:this.nick)||""},toString:function(){return WIM.json(this)}});WIM.Profile.alias=true;WIM.Message=Base.extend({date:"",speakerID:"",speakerName:"",content:"",from:"",constructor:function(a){if(a.date){if(typeof a.date=="string"||typeof a.date=="number"){a.date=new Date(a.date)}}else{this.date=new Date()}WIM.Apply(this,a)},getContent:function(){return this.content||""},getName:function(){return this.speakerName},getDate:function(){return(this.date.getDate()!=new Date().getDate())?this.date.Format("m-d H:i:s"):this.date.Format("H:i:s")},isSelf:function(){return this.speakerID==WIM._me.id}});WIM.MessageMgr=Base.extend({constructor:function(b){b=b||{};this.items=[];var a=this;if(b.items){if($.isArray(b.items)){b.items.reverse()}$.each(b.items,function(c,d){a.add(d)});delete b.items}WIM.Apply(this,b)},add:function(d,b,a,f,c){if(typeof d=="object"&&d.constructor==WIM.Message){this.items.unshift(d);return d}(typeof d=="object")?d=new WIM.Message(d):d=new WIM.Message({content:d,speakerID:b,speakerName:a,from:f,date:c});return arguments.callee.call(this,d)},get:function(a){return this.items.slice(0,a||this.items.length).reverse()}});WIM._ID=1000;WIM.ID=function(){return WIM._ID++};WIM.Person=Base.extend({constructor:function(a){WIM.Apply(this,a);this.profile=new WIM.Profile(this.pref);delete this.pref;this.id=this.login;this.uid=this.uid||WIM.ID();this.messages=new WIM.MessageMgr(a.messages)},updateProfile:function(a){if(this.profile){this.profile.update(a)}else{this.profile=new WIM.Profile(a)}return this},getProfile:function(b,a){WIM._service.viewBuddy({params:[WIM._me.id,WIM._me.secret,this.id,this.name,this.desc,this.type,this.visible],fn:b,scope:a||this})},insertMessage:function(b,c,a,d,f){return this.messages.add(new WIM.Message({date:b,speakerID:c,speakerName:a,content:d,from:f}))},getName:function(){return this.name&&this.name.length>0?this.name:(this.profile)?this.profile.getName():""},getStatus:function(){return WIM.Person.StatusMap[this.status]||{}},getTool:function(){return WIM.ToolMgr.get(this.prot)},isOnline:function(){return this.getStatus().sid==WIM.Person.USER_STATUS_ONLINE},isBusy:function(){return this.getStatus().sid==WIM.Person.USER_STATUS_BUSY},isNotbother:function(){return this.getStatus().sid==WIM.Person.USER_STATUS_DONT_BOTHER},isAway:function(){return this.getStatus().sid==WIM.Person.USER_STATUS_AWAY},isOffline:function(){return this.getStatus().sid==WIM.Person.USER_STATUS_OFFLINE},hasProt:function(a){return this.prot&&(this.prot&a)},hasQQ:function(){return this.hasProt(WIM.Person.PROT_QQ)},hasMSN:function(){return this.hasProt(WIM.Person.PROT_MSN)},hasDefault:function(){return this.hasProt(WIM.Person.PROT_DEFAULT)},isDefault:function(){return this.prot==WIM.Person.PROT_DEFAULT}});WIM.Person.StatusMap={set:function(){var b=arguments;for(var c=0;c<b.length;c+=3){this[b[c]]={sid:b[c],text:b[c+1],iconCls:b[c+2]}}}};WIM.Person.StatusMap.set(WIM.Person.USER_STATUS_ONLINE=0,"Online","wim-status-online",WIM.Person.USER_STATUS_BUSY=1,"Busy","wim-status-busy",WIM.Person.USER_STATUS_DONT_BOTHER=2,"Do Not Disturb","wim-status-notbother",WIM.Person.USER_STATUS_AWAY=3,"Away","wim-status-away",WIM.Person.USER_STATUS_OFFLINE=4,"Offline","wim-status-offline");delete WIM.Person.StatusMap.set;WIM.Person.PROT_DEFAULT=0;WIM.Person.PROT_MSN=1;WIM.Person.PROT_QQ=2;WIM.Person.PROT_GTALK=3;WIM.Collection=Base.extend({constructor:function(a){this.profile=new WIM.Profile(a.profile||a.pref||{});delete a.profile;delete a.pref;WIM.Apply(this,a);this.BuddyList={};this.onlines=0},addMember:function(a){if(a){if(a.constructor==WIM.Buddy){this.BuddyList[a.id]=a;if(!a.isOffline()){this.onlines++}}else{if(a.constructor==Array){a.each(function(b,c){this.addMember(c)},this)}else{this.addMember(new WIM.Buddy(a))}}}return this},removeMember:function(a){if(a&&a.id){if(!a.isOffline()&&this.onlines>0){--this.onlines}delete this.BuddyList[a.id]}},updateProfile:function(a){if(a.constructor==WIM.Profile){this.profile=a}else{if(typeof a=="object"){this.profile.update(a)}}},getMember:function(b){var a=this.BuddyList[b];if(!a&&typeof b=="string"){this.addMember({blogin:b});a=this.getMember(b)}return a},hasMember:function(a){return this.BuddyList.hasOwnProperty(a)},total:function(){var b=0;for(var a in this.BuddyList){if(!this.BuddyList[a].logoff){b++}}return b},each:function(f,d){for(var c in this.BuddyList){var a=this.BuddyList[c];if(!a.logoff){f.call(d||a,c,a)}}}});WIM.Group=WIM.Collection.extend({constructor:function(a){this.base(a)},isDefault:function(){return this.type==WIM.Group.TYPE_DEFAULT},isBlocked:function(){return this.type==WIM.Group.TYPE_BLOCKED},isPlugin:function(){return this.type==WIM.Group.TYPE_PLUGIN},isQun:function(){return this.type==WIM.Group.TYPE_QUN},isRequest:function(){return this.type==WIM.Group.TYPE_REQUEST},isUser:function(){return this.type==WIM.Group.TYPE_USER},hasRight:function(){return this.isUser()||this.isPlugin()||this.isQun()},updateProfile:function(a,c,b){a.valid=true;this.profile.update(a);WIM._service.editGroupPref({params:[WIM._me.id,WIM._me.secret,this.id,this.profile.toString()],fn:c,scope:b})},rename:function(a,c,b){WIM._service.renameGroup({params:[WIM._me.id,WIM._me.secret,this.id,this.type,a]});this.name=a;if(c){c.call(b||this,a,this)}},remove:function(c,b){for(var a in this.BuddyList){WIM._me.defaultGroup.addMember(this.BuddyList[a])}WIM._service.removeGroup({params:[WIM._me.id,WIM._me.secret,this.id,this.type],fn:c,scope:b||this});WIM._me.removeGroupData(this)}});WIM.Group.TYPE_DEFAULT=1;WIM.Group.TYPE_BLOCKED=3;WIM.Group.TYPE_PLUGIN=5;WIM.Group.TYPE_QUN=4;WIM.Group.TYPE_REQUEST=2;WIM.Group.TYPE_USER=0;WIM.Group.TextBlockGroup="Blocked";WIM.Group.TextRequestGroup="Requested";WIM.Qun=WIM.Collection.extend({constructor:function(a){this.firstChat=true;this.base(a);this.messages=new WIM.MessageMgr(a.messages);if(a.loaded){this.setMembers(a.BuddyList);delete a.BuddyList}},isManager:function(){return this.level==WIM.Qun.LEVEL_MANAGER},isMember:function(){return this.level==WIM.Qun.LEVEL_MEMBER},isNotMember:function(){return this.level==WIM.Qun.LEVEL_NOT_MEMBER},isOwner:function(){return this.level==WIM.Qun.LEVEL_OWNER},isQun:function(){return this.type==WIM.Qun.TYPE_QUN},isFormalMeet:function(){return this.type==WIM.Qun.TYPE_FORMAL_MEET},hasRight:function(){return this.isOwner()||this.isManager()},update:function(a,c,b){WIM.Apply(this,a);WIM._service.qunUpdate({params:[WIM._me.id,WIM._me.secret,this.id,this.name,this.desc,this.notice,this.type,this.joinType,this.visiType],fn:c,scope:b||this})},rename:function(a,c,b){if(this.name!=a){this.name=a;this.update();if(c){c.call(b||this,this)}}},remove:function(b,a){WIM._service.qunDelete({params:[WIM._me.id,WIM._me.secret,this.id],fn:b,scope:a||this});this.deleteQun()},deleteQun:function(){delete WIM._me.qunList[this.id]},select:function(b,a){WIM._service.qunSelect({params:[WIM._me.id,WIM._me.secret,this.id],fn:function(c){c={desc:"football fans",joinType:WIM.Qun.JOIN_FREE,level:WIM.Qun.LEVEL_OWNER,name:"Football Fans",notice:"notice here",type:WIM.Qun.TYPE_QUN,visiType:WIM.Qun.VISI_PUBLIC};WIM.Apply(this,c);if(b){b.call(a||this,this)}},scope:this})},invite:function(f,c,b,a){if(f.constructor!=Array){f=[f]}var d="["+f.join(",")+"]";WIM._service.qunInvite({params:[WIM._me.id,WIM._me.secret,this.id,d,c],fn:b,scope:a})},kickoff:function(d,c,b,a){WIM._service.qunKickOut({params:[WIM._me.id,WIM._me.secret,this.id,d.blogin,c],fn:function(h){var f=new Boolean(h);if(f){this.removeMember(d);if(b){b.call(a||this)}}},scope:this})},quit:function(b,a){WIM._service.qunSelfQuit({params:[WIM._me.id,WIM._me.secret,this.id],fn:function(c){this.deleteQun();if(b){b.call(a||this)}},scope:this})},upgrade:function(d,c,b,a){WIM._service.qunUpdateMemberLevel({params:[WIM._me.id,WIM._me.secret,this.id,d.blogin,c],fn:function(f){if(f){d.level=c;if(b){b.call(a||this)}}},scope:this})},selectMembers:function(c,b,a){if(this.loaded){if(b){b.call(a||this,this)}return this}else{WIM._service.qunSelectMembers({params:[WIM._me.id,WIM._me.secret,this.id,c||WIM.Qun.LEVEL_All],fn:function(d){this.setMembers(d);if(b){b.call(a||this)}},scope:this})}},setMembers:function(b){this.loaded=true;var a=this;$.each(b,function(d,f){var c=u.buddyList[f.login];if(!c){c=a.BuddyList[f.blogin];if(!c){f.blogin=f.login;f.prot=W.Person.PROT_DEFAULT;a.addMember(f)}else{c=W.Apply(c,f)}}else{c.level=f.level;a.addMember(c)}})},insertMessage:function(b,c,a,d,f){return this.messages.add(new WIM.Message({date:b,speakerID:c,speakerName:a,content:d,from:f}))},sendMsg:function(c,b,a){WIM._service.discuss({params:[WIM._me.id,WIM._me.secret,this.id,c],fn:function(f){f=0;var d;if(f==0&&b!==false){d=this.insertMessage(undefined,WIM._me.id,WIM._me.getName(),c,WIM._Website)}if(b){b.call(a||this,f,d)}},scope:this});return this},speak:function(c,a,b){if(!c.id){c=this.getMember(c)}return this.insertMessage(a,c.id,c.getName(),b)}});WIM.Qun.LEVEL_MANAGER=8;WIM.Qun.LEVEL_MEMBER=4;WIM.Qun.LEVEL_NOT_MEMBER=0;WIM.Qun.LEVEL_USER_INVITE=1;WIM.Qun.LEVEL_QUN_INVITE=2;WIM.Qun.LEVEL_OWNER=16;WIM.Qun.LEVEL_All=31;WIM.Qun.TYPE_FORMAL_MEET=0;WIM.Qun.TYPE_QUN=1;WIM.Qun.JOIN_FREE=0;WIM.Qun.JOIN_MANAGER_ONLY=30;WIM.Qun.JOIN_NEED_APPROVE=20;WIM.Qun.VISI_PRIVATE=0;WIM.Qun.VISI_SUMMARY=10;WIM.Qun.VISI_PUBLIC=20;WIM.Meet=WIM.Qun.extend({constructor:function(a){WIM.Apply(this,a);this.kickoff=this.updateMemberLevel=this.update=null},invite:function(b,d){var c=this.addMember.bind(this);var a=this;WIM._service.invite(WIM._me.id,WIM._me.secret,this.id,b.id,function(f){if(f){c(b);d.call(a,f,b)}})}});WIM.Buddy=WIM.Person.extend({entry:"www.g.cn",constructor:function(a){$.extend(this,{status:WIM.Person.USER_STATUS_OFFLINE,signature:"",updated:false,firstChat:true});a.login=a.blogin;this.base(a);try{this.calcPRI()}catch(b){}return this},getName:function(){var a=this.base();return(a&&a.length>0)?a:this.login},getColletion:function(){return WIM._me.groupList[this.gid]},getCls:function(){return this.status==WIM.Person.USER_STATUS_OFFLINE?this.getTool().iconClsOff:this.getTool().iconCls},setStatus:function(a){if(this.status!=a){if(a==WIM.Person.USER_STATUS_OFFLINE){this.getColletion().onlines--}else{if(this.status==WIM.Person.USER_STATUS_OFFLINE){this.getColletion().onlines++}}this.status=a;this.recalc=true}},setType:function(a){this.type=a;this.recalc=true},sendMsg:function(d,c,b){var a;if(c!==false){a=this.insertMessage(undefined,getWIM()._me.id,getWIM()._me.getName(),d,getWIM()._Website)}WIM._service.whisper({params:[WIM._me.id,WIM._me.secret,this.prot,this.id,d],fn:function(f){if(new Boolean(f)!=true&&c){c.call(b||this,a)}},scope:this});return a},speak:function(a,b){return this.insertMessage(a,this.id,this.getName(),b)},tellyou:function(){try{getWIM()._service.typing({params:[WIM._me.id,WIM._me.secret,this.id,true]})}catch(a){}},view:function(a){if(!this.updating&&(a||!this.updated)){this.updated=this.updating=true;WIM._service.viewBuddy({params:[WIM._me.id,WIM._me.secret,this.prot,this.id]})}return this},accept:function(c,b,a){WIM._service.acceptBuddy({params:[WIM._me.id,WIM._me.secret,this.prot,this.id,c],fn:function(d){d=0;if(d==WIM.Error.SUCCESS||d==WIM.Error.ERR_INTERNAL_ERROR){this.gid=c;WIM._me.groupList[c].addMember(this);if(b){b.call(a||this,this)}}},scope:this});return this},reject:function(c,b,a){WIM._service.rejectBuddy({params:[WIM._me.id,WIM._me.secret,this.prot,this.id,c],fn:function(d){d=0;WIM.Error.on(WIM.Error.SUCCESS,function(){if(b){b.call(a||this)}});WIM.Error.doAction(d)},scope:this})},block:function(b,a){WIM._service.blockBuddy({params:[WIM._me.id,WIM._me.secret,this.blogin,true],fn:b,scope:a||this});this.removeData();this.setBlocked();WIM._me.blockedGroup.addMember(this)},unblock:function(b,a){WIM._service.blockBuddy({params:[WIM._me.id,WIM._me.secret,this.blogin,false],fn:b,scope:a||this});this.setOK();WIM._me.blockedGroup.removeMember(this);WIM._me.groupList[this.gid].addMember(this)},updateProfile:function(a,c,b){this.base(a);this.profile.valid=true;if(c!==false){WIM._service.updateBuddyPref({params:[WIM._me.id,WIM._me.secret,this.prot,this.blogin,this.profile.toString()],fn:c,scope:b||this})}return this},updateGroup:function(c,b,a){WIM._service.updateBuddyGid({params:[WIM._me.id,WIM._me.secret,this.prot,this.blogin,c],fn:b,scope:a||this});this.updateGroupData(c)},updateGroupData:function(a){this.removeData();this.gid=a;WIM._me.groupList[a].addMember(this)},calcPRI:function(re){if(this.recalc||re||this.pri===undefined){var arr=[],n=0;arr.push(this.isOnline()?"1000000":"0",this.isBusy()?"100000":"0",this.isNotbother()?"10000":"0",this.isAway()?"1000":"0",this.id?String(this.id.charCodeAt(0)):"0");eval(" n = "+arr.join("+"));this.recalc=false;this.pri=n*(this.isRequested()||this.isBlocked()?-1:1)}return this.pri},remove:function(b,a){WIM._service.removeBuddy({params:[WIM._me.id,WIM._me.secret,this.prot,this.blogin],fn:b,scope:a||this});WIM._me.removeBuddyData(this)},removeData:function(){if(WIM._me.groupList[this.gid]){WIM._me.groupList[this.gid].removeMember(this)}},isFriend:function(){return WIM._me.buddyList.hasOwnProperty(this.id)},isSelf:function(){return this.id==WIM._me.id},isOK:function(){return this.type==WIM.Buddy.TYPE_OK},isRequested:function(){return this.type==WIM.Buddy.TYPE_REQUESTED},isBlocked:function(){return this.type==WIM.Buddy.TYPE_BLOCKED},setOK:function(){this.type=WIM.Buddy.TYPE_OK},setRequested:function(){this.type=WIM.Buddy.TYPE_REQUESTED},setBlocked:function(){this.type=WIM.Buddy.TYPE_BLOCKED}});WIM.Buddy.TYPE_OK=0;WIM.Buddy.TYPE_REQUESTED=1;WIM.Buddy.TYPE_BLOCKED=2;WIM.User=WIM.Person.extend({constructor:function(a){delete a.password;$.extend(this,{autoReplyFlag:false,buddyList:{},groupList:{},qunList:{},autoReplyList:[]});delete a.blockedGroup;delete a.defaultGroup;delete a.requestGroup;delete a.defaultPref;if(a.groupList){this.setGroups(a.groupList);delete a.groupList}if(a.buddyList){this.setBuddyList(a.buddyList);delete a.buddyList}window.u=this;if(a.qunList){this.setQuns(a.qunList);delete a.qunList}this.base(a);this.status=this.lastStatus},selectDomainPref:function(b,a){if(this.domainPref){if(b){b.call(a||this,this.domainPref)}}else{WIM._service.selectDomainPref({params:[this.id,this.secret,this.server_rep],fn:function(c){c={homeUrl:"http://www.google.com",type:0,signatureSuffix:"google",adMsg:"google",brand:"Google",enable:true};if(c){this.domainPref=c;if(b){b.call(a||this,this.domainPref)}}},scope:this})}},getName:function(){return(this.defaultPref?this.defaultPref.nick:this.login)||this.login||"\u93b4\u621e\u69f8\u93c3\u72b2\u6095\u59d8\ufffd..."},logout:function(b,a){WIM._service.logout({params:[this.id,this.secret],fn:b,scope:a||this})},bindProt:function(f,b,a,d,c,i){var h=WIM.ToolMgr.get(f);if(h){h.plogin=b;WIM._service.bindProt({params:[this.id,this.secret,f,b,a],fn:function(){h.useable=true;if(i){this.loginProt(f,b,d,c,true)}else{if(d){d.call(c||this,f,b)}}},scope:this})}},logoutProt:function(c,b,a){var d=WIM.ToolMgr.get(c);this.eachBuddy(function(h,f){if(f.prot==c){f.removeData()}});if(d.logon===false){if(b){b.call(a||this,d)}}else{d.logon=false;WIM._service.logoutProt({params:[this.id,this.secret,c],fn:b,scope:a})}},loginProt:function(h,a,f,d,c){var b=WIM.ToolMgr.get(h);if(b.logon!==true&&b.waiting!==true){b.waiting=true;WIM._service.loginProt({params:[this.id,this.secret,h],fn:function(i){i=0;if(i==0){if(c){b.autoLoad=true;b.fn=f||function(){};b.scope=d}else{if(f){f.call(d||this,h,a)}}}else{alert("\u9427\u8bf2\u7d8d"+b.name+"\u9286\ufffd"+a+"\u9286\u6226\u654a\u7487\ue224\u7d12\n\n\t\u7487\u950b\ue5c5\u93cc\u30e7\u6564\u93b4\u5cf0\u6095\u6d93\u5ea1\u7611\u942e\u4f79\u69f8\u935a\ufe3d\ue11c\u7ead\ufffd");if(f){f.call(d||this,h,a,false)}}},scope:this})}else{if(f){f.call(d||this,h,a)}}},refreshProt:function(c,b,a){var d=WIM.ToolMgr.get(c);if(d.logon&&!d.updated){d.updated=true;WIM._service.syncBuddyList({params:[this.id,this.secret,c],fn:b,scope:a})}else{if(b){b.call(a||this,c)}}},removeProt:function(c,b,a){WIM._service.removeProt({params:[this.id,this.secret,c],fn:function(){this.eachBuddy(function(h,f){if(f.prot==c){this.removeBuddyData(f)}},this);var d=WIM.ToolMgr.get(c);d.useable=d.updated=d.logon=d.hide=d.waiting=false;if(b){b.call(a||this,c)}},scope:this})},changeStatus:function(b,f,d){var c=500,a=this;this.protArr.each(function(h,j){setTimeout(function(){WIM._service.changeStatus({params:[a.id,a.secret,j.prot,b]})},h*c)});this.status=b;if(f){f.call(d||this,b)}},changeMood:function(c,b,a){if(this.domainPref&&this.domainPref.signatureSuffix&&this.domainPref.signatureSuffix.length>0){c+="  "+this.domainPref.signatureSuffix}WIM._service.changeSignature({params:[this.id,this.secret,c]});this.signature=c;if(b){b.call(a||this,c)}},getAllProts:function(b,a){WIM._service.getAllProts({params:[this.id,this.secret],fn:function(c){if(!$.isArray(c)){c=[]}c.unshift({prot:WIM.Tool.DEFAULT,plogin:this.login,lastLoginTime:+new Date()});c.push({prot:WIM.Tool.MSN,plogin:this.login,lastLoginTime:+new Date()});c.each(function(d,f){f.useable=true});this.protArr=c;this.setAllProts(c);if(b){b.call(a||window,c)}},scope:this})},setAllProts:function(a){$.each(a,function(b,c){WIM.ToolMgr.get(c.prot).update(c)})},getAutoReplies:function(b,a){WIM._service.getAutoReplies({params:[this.id,this.secret],fn:function(c){c=["I'm offline","I'm Busy","go away"];this.setAutoReplies(c);if(b){b.call(a||this,this.autoReplyList)}},scope:this})},setAutoReplies:function(b){var a=this;$.each(b,function(c,d){a.addReply(d)});this.autoReplyList.sort()},autoReply:function(f,a,d,c){a=a||false;WIM._service.autoReply({params:[this.id,this.secret,a,f],fn:d,scope:c||this});var b=$.inArray(f,this.autoReplyList);b==-1?this.addReply({text:f,checked:true}):(a?this.autoReplyList[b].checked=true:this.autoReplyList[b].checked=false)},addReply:function(a){(typeof a=="string")?this.autoReplyList.push({text:a}):this.autoReplyList.push(a)},getAllGroups:function(b,a){WIM._service.getAllGroups({params:[this.id,this.secret],fn:function(c){c=[{id:1,name:"Friends",type:WIM.Group.TYPE_DEFAULT},{id:2,name:"Classmates",type:WIM.Group.TYPE_USER},{id:3,name:"worker",type:WIM.Group.TYPE_USER},{id:4,name:"football",type:WIM.Group.TYPE_USER}];this.setGroups(c);if(b){b.call(a||window,this.groupList)}},scope:this})},setGroups:function(c){var b=this,a=[];$.each(c,function(d,h){var f=new WIM.Group(h);a.push(f);b.addGroupData(f);if(f.isDefault()){b.defaultGroup=f;b.defaultPref=f.profile}else{if(f.isBlocked()){b.blockedGroup=f}else{if(f.isRequest()){b.requestGroup=f}}}});if(!this.requestGroup){this.addGroupData(this.requestGroup=new WIM.Group({id:"wim_g_req",name:WIM.Group.TextRequestGroup,type:WIM.Group.TYPE_REQUEST}))}if(!this.blockedGroup){this.addGroupData(this.blockedGroup=new WIM.Group({id:"wim_q_blk",name:WIM.Group.TextBlockGroup,type:WIM.Group.TYPE_BLOCKED}))}return a},getAllQuns:function(b,a){WIM._service.qunSelectJoined({params:[this.id,this.secret,WIM.Qun.TYPE_QUN,WIM.Qun.LEVEL_All],fn:function(c){c=[{id:1,desc:"football fans",joinType:WIM.Qun.JOIN_FREE,level:WIM.Qun.LEVEL_OWNER,name:"Football Fans",notice:"notice here",type:WIM.Qun.TYPE_QUN,visiType:WIM.Qun.VISI_PUBLIC},{id:2,desc:"classic music",joinType:WIM.Qun.JOIN_FREE,level:WIM.Qun.LEVEL_MEMBER,name:"classic music",notice:"classic music",type:WIM.Qun.TYPE_QUN,visiType:WIM.Qun.VISI_PRIVATE}];this.setQuns(c);if(b){b.call(a||this)}},scope:this})},setQuns:function(b){if(b){var a=this;$.each(b,function(c,d){a.addQunData(new WIM.Qun(d))})}},selectJoinedMeets:function(b,a){WIM._service.selectJoinedQuns({params:[this.id,this.secret,WIM.Qun.TYPE_FORMAL_MEET,WIM.Qun.LEVEL_MANAGER|WIM.Qun.LEVEL_MEMBER|WIM.Qun.LEVEL_NOT_MEMBER|WIM.Qun.LEVEL_OWNER],fn:function(c){c.each(function(d,f){this.addMeetData(new WIM.Meet(f))},this);if(b){b.call(a||this,c)}},scope:this})},getBuddyList:function(h,a,b,f,d){WIM.ToolMgr.get(h).useable=true;if(h!=WIM.Tool.DEFAULT){var c=true;this.loginProt(h,a,function(){},this,c)}else{WIM._service.getBuddyListSnapshot({params:[this.id,this.secret,a,h],fn:function(i){i=[{blogin:"buddy1"+h,gid:1,name:"Tom",signature:"Talks at the 2009 jQuery Conference",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK},{blogin:"buddy2"+h,gid:2,name:"Jonh Resing",signature:"300 people attended",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK},{blogin:"buddy3"+h,gid:3,name:"Lily Allen",signature:"Comprehensive DOM, Event, Animation, and Ajax JavaScript Library.",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK},{blogin:"buddy4"+h,gid:4,name:"Abba",signature:"Talks at the 2009 jQuery Conference",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK},{blogin:"buddy5"+h,gid:1,name:"Dean",signature:"Small, cross-browser, JavaScript CSS selector library.",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK},{blogin:"buddy6"+h,gid:1,name:"lady gaga",signature:"A port of the Processing Visualization language to JavaScript.",status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK}];this.setBuddyList(i,h);if(f){f.call(d||this,b,h,a)}},scope:this})}},getAll:function(b,a){this.protArr.each(function(c,d){this.getBuddyList(d.prot,d.plogin,c,b,a)},this)},setBuddyList:function(b,c){var a=this,b=b||[];$.each(b,function(d,f){if(c!==undefined){f.prot=c}a.addBuddyData(new WIM.Buddy(f))})},maxgid:1000,addGroup:function(a,c,b){WIM._service.addGroup({params:[this.id,this.secret,a,WIM.Group.TYPE_USER],fn:function(d){var f=null;d=this.maxgid++;if(d>0){f=new WIM.Group({id:d,name:a,type:WIM.Group.TYPE_USER,uid:WIM._me.id});this.addGroupData(f)}if(c){c.call(b||this,f)}},scope:this})},maxqid:1000,createQun:function(a,d,c,b){WIM._service.qunCreate({params:[this.id,this.secret,a,d,WIM.Qun.TYPE_QUN,WIM.Qun.JOIN_FREE,WIM.Qun.VISI_PUBLIC],fn:function(h){h=this.maxqid++;var f=new WIM.Qun({id:h,name:a,desc:d,type:WIM.Qun.TYPE_QUN,level:WIM.Qun.LEVEL_OWNER,visiType:WIM.Qun.VISI_PUBLIC,joinType:WIM.Qun.JOIN_FREE,createTime:new Date()});this.addQunData(f);if(c){c.call(b||this,f)}},scope:this})},createMeet:function(a,f,c,b){var d=true;WIM._service.createQun({params:[this.id,this.secret,a,f,WIM.Qun.TYPE_FORMAL_MEET,d],fn:function(i){var h=new WIM.Meet({id:i,name:a,desc:f,type:WIM.Qun.TYPE_FORMAL_MEET,visible:d,createTime:new Date()});this.addMeetData(h);if(c){c.call(b||this,h)}},scope:this})},findBuddyFn:function(c,b){var a=[];$.each(this.buddyList,function(d,f){if(c.call(b||this,f,d)===true){a.push(f)}});return a},findBuddyCombo:function(a){return this.findBuddyFn(function(c){var b=true;$.each(a,function(f,d){if(c[f]!=d){return b=false}});return b})},addBuddy:function(f,d,c,h,b,a){if(this.hasBuddy(d)){alert("you alraedy add this buddy"+d)}else{WIM._service.addBuddy({params:[this.id,this.secret,f,d,c,h],fn:function(k){k=0;if(k==0){var j=this.findBuddyCombo({blogin:d,prot:f,gid:c});if(j.length==0){var i=new WIM.Buddy({bid:WIM.MAX_ID+1,prot:f,blogin:d,type:WIM.Buddy.TYPE_REQUESTED,gid:c});this.addBuddyData(i)}if(b){b.call(a||this,j,i,k)}}else{if(k==WIM.Error.ERR_USER_NOT_FOUND){alert(d+"\u9422\u3126\u57db\u6d93\u5d85\u74e8\u9366\ufffd...")}else{alert("\u5a23\u8bf2\u59de"+d+"\u9422\u3126\u57db\u6fb6\u8fab\u89e6...")}}},scope:this})}},addBuddyData:function(a){this.buddyList[a.id]=a;if(a.isBlocked()){this.blockedGroup.addMember(a)}else{if(a.isRequested()){this.requestGroup.addMember(a)}else{if(this.groupList[a.gid]){this.groupList[a.gid].addMember(a)}}}},getBuddy:function(b,c){var a=this.buddyList[b];if(!a){a=new WIM.Buddy(typeof c=="object"?c:{gid:WIM._me.defaultGroup.id,prot:c,blogin:b,status:WIM.Person.USER_STATUS_ONLINE,type:WIM.Buddy.TYPE_OK});WIM._me.addBuddyData(a)}else{if(typeof c=="object"){if(typeof c.gid=="number"&&(a.gid!=c.gid||!a.getColletion().hasMember(a.id))){a.updateGroupData(c.gid);delete c.gid}WIM.Apply(a,c)}}return a},hasBuddy:function(a){return this.buddyList.hasOwnProperty(a)},removeBuddyData:function(a){a.getColletion().removeMember(a);delete this.buddyList[a.id];a=null},addTool:function(a){if($.inArray(a,this.protArr)==-1){this.protArr.push(a)}},addGroupData:function(a){this.groupChanged=true;this.groupList[a.id]=a},removeGroupData:function(a){this.groupChanged=true;delete this.groupList[a.id]},addQunData:function(a){this.qunList[a.id]=a},addMeetData:function(a){this.meetList[a.id]=a},eachBuddy:function(b,a){$.each(this.buddyList,function(d,c){b.call(a||this,d,c)})}});WIM.Error={errors:{},SUCCESS:0,ERR_BAD_REQ:-1,ERR_AUTH_FAIL:-2,ERR_USER_NOT_FOUND:-10,ERR_GROUP_NOT_FOUND:-4,ERR_BUDDY_BLOCKED:-5,ERR_BUDDY_ADD_ALREADY:-6,ERR_GROUP_NAME_DUP:-7,ERR_GROUP_ERR_TYPE:-8,ERR_ACCEPT_FORBIDDEN:-9,ERR_REJECT_FORBIDDEN:-24,successHandel:function(){},completeHandle:function(){},alertHandle:function(){},alert:true,init:function(){this.addError(this.SUCCESS=0,"Success",this.ERR_BAD_REQ=-1,"\u95bf\u6b12\ue1e4\u9428\u52ee\ue1ec\u59f9\ufffd",this.ERR_AUTH_FAIL=-2,"\u7481\u3088\u7609\u6fb6\u8fab\u89e6",this.ERR_INTERNAL_ERROR=-3,"\u8930\u64b3\u58a0\u93c8\u5d85\u59df\u6d93\u5d85\u5f72\u9422\ufffd",this.ERR_3PT=-4,"\u7ed7\ue0ff\u7b01\u93c2\u89c4\u6e47\u9354\u2032\u7b09\u9359\ue21c\u6564",this.ERR_USER_NOT_FOUND=-10,"\u7487\u30e7\u6564\u93b4\u8702\u7b09\u701b\u6a3a\u6e6a",this.ERR_GROUP_NOT_FOUND=-4,"\u7487\u30e7\u7c8d\u6d93\u5d85\u74e8\u9366\ufffd",this.ERR_BUDDY_BLOCKED=-30,"\u7487\u30e5\u30bd\u9359\u5b2a\u51e1\u7f01\u5fda\ue766\u93c0\u60e7\u53c6\u699b\u621d\u6095\u9357\u66da\u7c21",this.ERR_BUDDY_ADD_ALREADY=-6,"\u7487\u30e5\u30bd\u9359\u5b2a\u51e1\u7f01\u5fd4\u574a\u9354\u72b1\u7c21",this.ERR_GROUP_NAME_DUP=-31,"\u7f01\u52eb\u6095\u95b2\u5d85\ue632",this.ERR_GROUP_ERR_TYPE=-32,"\u95bf\u6b12\ue1e4\u9428\u52ed\u7c8d\u7eeb\u8bf2\u7037",this.ERR_ACCEPT_FORBIDDEN=-24,"\u7487\u30e6\u6437\u6d63\u6ec6\ue766\u95c3\u7ed8\ue11b",this.ERR_PROT_BIND_INVALID=-40,"\u6769\u6a3b\u75c5\u93c8\u590c\u7ca6\u7039\u6c33\ue1da\u9357\u5fda\ue185",this.ERR_BUDDY_ADD_ALREADY=-21,"\u7487\u30e5\u30bd\u9359\u5b2a\u51e1\u7f01\u5fd4\u574a\u9354\u72b1\u7c21",this.ERR_ACCEPT_ALREADY=-23,"\u5bb8\u832c\u7ca1\u9354\u72b1\u8d1f\u6fc2\u85c9\u5f38\u6d5c\ufffd",this.ERR_REJECT_FORBIDDEN=-22,"\u7ec2\u4f79\ue11b\u9359\u621d\u56ad\u93b7\u6394\u7cb7\u9354\u72b1\u8d1f\u6fc2\u85c9\u5f38\u9428\u52ec\u6437\u6d63\ufffd");this.editError(this.SUCCESS,"\u93bf\u5d84\u7d94\u93b4\u612c\u59db",function(a){this.alertHandle(a);this.successHandel(a)})},addError:function(){for(var a=0;a<arguments.length;a+=2){this.errors[arguments[a]]={code:arguments[a],desc:arguments[a+1]||"",fn:function(){}}}},editError:function(b,c,a){this.errors[b]={code:b,desc:c,fn:a}},on:function(){var b=Array.prototype.slice.call(arguments,0);if(b.length==1){b[1]=b[0];b[0]=this.SUCCESS}for(var c=0;c<b.length;c+=2){if(typeof b[c]=="number"){b[c]=[b[c]]}for(var a=0;a<b[c].length;a++){$.extend(this.errors[b[c][a]],{code:b[c][a],fn:b[c+1]})}}},doAction:function(a){if(this.errors.hasOwnProperty(a)){if(this.alert&&a!=this.SUCCESS){this.alertHandle(this.errors[a])}this.alert=true;if(this.errors[a].fn){this.errors[a].fn(this.errors[a])}}this.completeHandle()},recover:function(){this.alert=true}};WIM.Service=function(l){var h=navigator.userAgent.indexOf("MSIE 6")>=0;function m(i){return Object.prototype.toString.call(i)==="[object Array]"||(h&&i.hasOwnProperty("length")&&i.reverse!==undefined)}var d=(function(){var w=[],y={},i=0,q="",x=3;function v(){return window.ActiveXObject?(h?new ActiveXObject("Msxml2.XMLHTTP"):new ActiveXObject("Microsoft.XMLHTTP")):new XMLHttpRequest()}function r(z){var C=[];function D(E,F){C[C.length]=encodeURIComponent(E)+"="+encodeURIComponent(F)}for(var A in z){if(m(z[A])){for(var B=0;B<z[A].length;B++){D(A,z[A][B])}}else{D(A,z[A])}}return C.join("&").replace(/%20/g,"+")}function s(){var z=w.length;for(var A=0;A<z;A++){if(w[A]&&y[A]!==true&&(w[A].readyState==4||w[A].readyState==0)){y[A]=true;return w[A]}}var B=v();w.push(B);y[w.length-1]=true;return B}function t(D,B,A){if(d.suspend){return false}var F=s();F.open("POST",q,true);try{F.setRequestHeader("Accept","application/json, text/javascript, */*");F.setRequestHeader("Cache-Control","no-cache");F.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8")}catch(E){}function C(){try{return(F.status>=200&&F.status<300)||F.status==304||F.status==1223}catch(H){}return false}var z;F.onreadystatechange=function(){if(F&&F.readyState==4){z="success";var I;if(C()){try{I=window["eval"]("("+F.responseText+")")}catch(H){z="parseerror";d.handleError(z)}if(z=="success"){if(I==-2){d.handleError(z="authfail")}else{if(B){B.call(A||window,I);delete B;delete A}}}}else{d.handleError(z="timeout")}I=null;y[j]=false}};try{F.send(r(D))}catch(E){y[j]=false;d.handleError(z="ajaxerror")}}return{suspend:false,post:function(B,A,z){t(B,A,z);return this},setUrl:function(z){q=z},handleError:function(){},getInstance:s,stop:function(){this.suspend=true;for(var z=0;z<w.length;z++){try{w[z].abort()}catch(A){}w[z]=null}w.length=0}}})();var n="1.0",f="\u93bf\u5d84\u7d94\u6fb6\u8fa8\u6665 : \u6d93\u5ea2\u6e47\u9354\u2033\u6ad2\u95ab\u6c2b\u4fca\u6fb6\u8fab\u89e6\u951b\u5c83\ue1ec\u95b2\u5d86\u67ca\u9427\u8bf2\u7d8d!",b=true,h=navigator.userAgent.indexOf("MSIE 6")>=0,p=this,l=l||{},c=l.urlSend||WIM._urlSend,k=["echo","isUserExist","createUser","login","logout","loginProt","logoutProt","getAllProts","getAutoReplies","autoReply","changeStatus","updateBuddyGid","blockBuddy","removeBuddy","changeSignature","getBuddyListSnapshot","getAllGroups","renameGroup","removeGroup","editGroupPref","addGroup","qunSelectJoined","qunSelect","qunCreate","qunUpdate","qunDelete","qunSelfQuit","qunUpdateMemberLevel","qunSelectMembers","qunInvite","qunKickOut","discuss","viewBuddy","updateBuddyPref","rejectBuddy","acceptBuddy","whisper","typing","addBuddy","bindProt","removeProt","syncBuddyList","submitFeedback","selectDomainPref","putCrossDomainMsg"];d.handleError=function(i){if(i=="ajaxerror"||i=="authfail"||(!h&&i=="timeout")){d.stop();alert(f)}};d.setUrl(c);for(var j=0;j<k.length;j++){(function(){var i=k[j]+"";p[i]=function(r){r=r||{};if(m(r)){r={params:r}}var q={v:n,m:i};if(r.params&&r.params.length>0){q.p=r.params}if(r.fn){setTimeout(function(){r.fn.call(r.scope||window,true)},50)}}})()}this.stop=function(){d.stop()};this.start=function(){d.suspend=false};WIM.echo=this.echo;WIM.isUserExist=this.isUserExist;WIM.createUser=this.createUser;function a(){WIM.reload()}};WIM.Event=function(a){WIM.Apply(this,a)};WIM.Event.prototype={getTime:function(){return new Date(this.time).Format()},getBuddy:function(){return WIM._me.getBuddy(this.from,this.prot)},getQun:function(){return WIM._me.qunList[this.chatId]}};WIM.Apply(WIM.Event,{TYPE_ADD_BUDDY:50,TYPE_AUTH_FAIL:1,TYPE_CONNECT_FROM_OTHER:10,TYPE_SIGNATURE_CHANGE:22,TYPE_DOMAIN_DISABLED:12,TYPE_ERROR:0,TYPE_MEET_INVITE:40,TYPE_MEET_QUIT:41,TYPE_MSG_MEET:31,TYPE_MSG_QUN:32,TYPE_QUN_INVITE:60,TYPE_QUN_KICK_OUT:61,TYPE_MSG_WHISPER:30,TYPE_REQ_ACCEPT:51,TYPE_REQ_REJECT:52,TYPE_STATUS_CHANGE:20,TYPE_TYPING:21,TYPE_PROT_LOGIN_SUCCESS:100,TYPE_DATA_NEW_GROUP:80,TYPE_DATA_BUDDY_LIST:70,TYPE_DATA_BUDDY:90});WIM.EventMgr=function(){return{count:0,events:[],types:{},suspend:false,excuting:false,on:function(d,c,b,f){if(d.constructor==Array){var a=this;$.each(d,function(h,j){a.on(j)})}else{if(typeof d=="number"){this.types[d]={code:d,fn:c,scope:b,sync:f}}else{if(d.constructor==Object){this.types[d.code]=d}}}},completeHandle:function(b,a){this.unreg(b);this.waiting=false;this.excuting=false},reg:function(a){if(a.construct!=WIM.Event){a=new WIM.Event(a)}var b=this.types[a.type];if(b){if(b.sync&&(b.syncFn?b.syncFn.call(b.scope||this,a,b)!==false:true)){this.excute(a,b)}else{this.events.push(a);this.check()}}return a},unreg:function(a){return this.events.remove(a)},get:function(a){return a&&a>-1&&a<this.events.length?this.events[a]:this.events[0]},allDone:function(){return this.get()===undefined&&!this.excuting},check:function(){this.checking=true;if(this.events.length==0||this.suspend){if(this.loop){clearTimeout(this.loop)}this.checking=false}else{if(this.events.length>0){this.queue();this.loop=setTimeout(function(){WIM.EventMgr.check.call(WIM.EventMgr)},13)}}},queue:function(b){if(!this.waiting){this.waiting=true;var b=b||this.get(),a=this.types[b.type];if(!b){return}if(a.auto){this.doAction(b,a)}}},excute:function(b,a){if(a.fn&&a.sync){this.excuting=true;if(a.fn){a.fn.call(a.scope||b,b,a)}this.completeHandle(b,a)}},doAction:function(b,a){if($.inArray(b,this.events)>-1){if(a.fn){a.fn.call(a.scope||b,b,a)}this.completeHandle(b,a)}},stop:function(){this.suspend=true;this.excuting=false;if(this.loop){clearTimeout(this.loop)}},clear:function(){this.events.clear()}}}();WIM.Comet=function(a){WIM.Apply(this,a);this.init()};WIM.Comet.prototype={retry:13,TextTimeout:"\u93ba\u30e6\u6579\u93c8\u5d85\u59df\u9363\u3126\u79f7\u93ad\ue21a\u3051\u7490\u30ef\u7d1d\u7487\u70fd\u5678\u93c2\u626e\u6ae5\u8930\ufffd",TextDomain:"\u7487\u30e7\u7d89\u7ed4\u6b10\u6b8f\u93c3\u8235\u68e4\u5a09\u66da\u5a07\u9422\u3125\u5d1c\u6939\ue101\u6e47\u9354\ufffd",first:true,init:function(){this.data={login:WIM._me.id,secret:WIM._me.secret,first:true};if(window.server_rep){this.data.domain=WIM._me.server_rep=window.server_rep.domain}this.url=this.urlRect;WIM.C=this;WIM.EventMgr.on([{code:WIM.Event.TYPE_AUTH_FAIL,fn:this.failed,scope:this,sync:true},{code:WIM.Event.TYPE_DOMAIN_DISABLED,fn:function(){WIM._service.stop();this.stop();WIM.WinMgr.stop();WIM.EventMgr.clear();alert(this.TextDomain)},scope:this,sync:true}])},initFrame:function(){this.iframe=$("<iframe width='0' height='0' allowTransparency='true' scrolling='no' border='0' frameBorder='0' frameBorder='0'/>").hide().attr("src",this.urlFrame).appendTo(document.body)},check:function(a){return(a.type==WIM.Event.TYPE_CONNECT_FROM_OTHER&&a.prot==0)||a.type==WIM.Event.TYPE_DOMAIN_DISABLED},start:function(a){this.fn=a;if(!this.listener){this.initFrame()}else{this.listener.start()}this.running=true;if(a){setTimeout(a,100)}setTimeout(function(){WIM.EventMgr.reg({from:"login2",prot:WIM.Tool.MSN,time:123,to:"login2",type:WIM.Event.TYPE_PROT_LOGIN_SUCCESS})},2000)},error:function(){},failed:function(){if(this.running){this.stop();alert(WIM.C.TextTimeout)}},cross:function(a){this.listener=a;a.start()},accept:function(a){if(this.first){this.first=this.data.first=false;if(this.fn){this.fn()}delete this.fn;this.listener.setData(this.data)}if(a){WIM.EventMgr.reg(a)}},stop:function(){if(this.listener){this.listener.stop();this.running=false}}};WIM.Win=function(a){return this.init(a)};WIM.Win.prototype={data:{},result:{},autoOpen:true,property:{alwaysRaised:1,hotkeys:0,resizable:0,titlebar:1,"z-look":1,location:1,menubar:0,directories:0,scrollbars:0,status:0,toolbar:0,width:400,height:300,depended:1},init:function(a){Ext.applyIf(a.property||{},this.property);this.setData(a.data);WIM.Apply(this,a);if(this.autoOpen){this.open()}return this},open:function(){if(!this.handle||this.handle.closed){this.create()}else{this.handle.focus()}return this},create:function(){this.property.left=this.property.screenX=screen.availWidth/2-this.property.width/2;this.property.top=this.property.screenY=screen.availHeight/2-this.property.height/2;var a=[];for(var b in this.property){a.push(b+"="+this.property[b])}try{this.handle=window.open(this.url,this.name,a.join(","))}catch(c){alert("open failed")}return this},setData:function(a){WIM.Apply(this.data,a)},setResult:function(a){WIM.Apply(this.result,a)},close:function(){if(this.isOpen()){this.handle.close()}},isOpen:function(){return this.handle&&!this.handle.closed},callback:function(){if(this.data.fn){this.data.fn.apply(this.data.scope||this,arguments)}}};WIM.WinMgr=function(){return{wins:{},add:function(b,a,d,c){if(!this.suspend){a+=window.name;if(!this.get(a)){return this.wins[a]=new WIM.Win({url:b,name:a,property:d,data:c})}else{return this.get(a).open()}}},get:function(a){return this.wins[a]},destroy:function(){for(var a in this.wins){this.wins[a].close();delete this.wins[a]}},stop:function(){this.suspend=true;this.destroy()},start:function(){this.suspend=false}}}();window.Bubble={count:0,TodoTasks:new Ext.util.MixedCollection(),ShowTask:null,TextLook:"View",TextEdit:"Edit",addTask:function(a){a.data.chatId=a.id=a.type+"_"+a.data.id;this.TodoTasks.add(a.id,a);this.ShowTask=a;if(!a.notopen){this.openChatWindow()}},BuddyChat:function(a,d,c){this.addTask({type:1,data:a,fn:d,scope:c,title:a.getName(),iconCls:"WIM_Tab_Icon_Buddy"})},indexOf:function(a){return this.TodoTasks.indexOfKey(a)},LookPref:function(a,d,c){this.addTask({type:6,data:a,fn:d,scope:c,title:this.TextLook+a.getName(),iconCls:"icon_lp"})},QunChat:function(c,b,a){this.addTask({type:2,data:c,fn:b,scope:a,title:c.name,iconCls:"WIM_Tab_Icon_Qun"})},MemberMgr:function(d,c,b,a){this.addTask({type:5,data:d,list:c,fn:b,scope:a,title:d.name,iconCls:"icon_qun_mng"})},EditPref:function(c,b,a){this.addTask({type:4,data:c,fn:b,scope:a,title:this.TextEdit+c.name,iconCls:"WIM_Tab_Icon_Edit"})},RemoveTask:function(a){a=typeof a=="string"?a:o.id;this.TodoTasks.removeKey(a)},ClearTask:function(a){if(a){this.lastTasks=this.TodoTasks.clone()}this.TodoTasks.clear();this.ShowTask=null},recover:function(){try{this.TodoTasks=this.lastTasks.clone()}catch(a){}},openChatWindow:function(b,a){if(g.isWin){checkTask()}else{if(!this.chatWindow||!this.chatWindow.isOpen()){WIM.Paint("<h1>Open chat window...</h1>");this.callback=b;this.callbackscope=a;this.chatWindow=WIM.WinMgr.add(WIM.chatWindowUrl,WIM._me.id+"_wimChatWindow",{width:600,height:450},{fn:function(){WIM.Efface();if(this.callback){this.callback.apply(this.callbackscope||this,arguments)}},scope:this});WIM.EventMgr.on({code:WIM.Event.TYPE_TYPING,fn:function(f,c){var d=this.getPanel("1_"+f.from);if(d){d.showTyping()}},scope:this,sync:true})}else{if(this.chatWindow.isOpen()){if(b){b.call(a||this)}this.chatWindow.handle.focus();if(this.chatWindow.handle.checkTask){this.chatWindow.handle.checkTask()}}}}},prepareData:function(){W.Bubble.chatWindow.handle.checkList(Ext.encode(WIM._me),Ext.encode(WIM.ToolMgr),WIM.Profile.alias,WIM._ID,W.Bubble.save());setTimeout(function(){if(g){g.close()}},10000)},getPanel:function(b){if(this.TodoTasks.key(b)){try{return g.isWin?WIM.ChatTabPanel.items.get(b):this.chatWindow.handle.WIM.ChatTabPanel.items.get(b)}catch(a){}}},isBuddyChating:function(a){return this.isChating("1_"+a)},isQunChating:function(a){return this.isChating("2_"+a)},isOpen:function(){return g.isWin||this.chatWindow&&this.chatWindow.isOpen()},isChating:function(a){return this.isOpen()&&this.TodoTasks.containsKey(a)?this.TodoTasks.get(a):false},remove:function(a){g.isWin?WIM.ChatTabPanel.remove(a):this.chatWindow.handle.WIM.ChatTabPanel.remove(a)},close:function(){if(this.isOpen()&&!g.isWin){this.chatWindow.close()}},save:function(){return $.map(this.TodoTasks.items,function(a){return a.id})},load:function(a){for(var b=0;b<a.length;b++){this.TodoTasks.add(a[b],{id:a[b]})}var c=/^(\d)_(\S+)$/;WIM.ChatTabPanel.items.eachKey(function(i,d){var h=c.exec(i),f;if(h&&h[1]&&h[2]){switch(Number(h[1])){case 1:case 6:f=WIM._me.getBuddy(h[2]);break;case 2:case 5:f=WIM._me.qunList[h[2]];break;case 4:f=WIM._me.groupList[h[2]]}d.setData(f)}})}};cookie=function(a){if(a){$.extend(this,a)}this.state=this.readCookies()};cookie.prototype={path:"/",domain:null,secure:false,expires:new Date(new Date().getTime()+(1000*3600*24*30)),set:function(b,c,a){if(c==undefined||c===null){return this.clear(b)}this.setCookie(b,c,a);this.state[b]=c},get:function(b,a){return this.state[b]===undefined?a||null:this.state[b]},getJson:function(name){return eval("temp="+this.get(name,"{}"))},clear:function(a){this.clearCookie(a);delete this.state[a]},readCookies:function(){var d={};var i=document.cookie+";";var b=/\s?(.*?)=(.*?);/g;var h;while((h=b.exec(i))!=null){var a=h[1];var f=h[2];if(a){d[a]=this.decodeValue(f)}}return d},reload:function(){this.state=this.readCookies()},setCookie:function(b,c,a){document.cookie=b+"="+this.encodeValue(c)+((a||this.expires==null)?"":("; expires="+this.expires.toGMTString()))+((this.path==null)?"":("; path="+this.path))+((this.domain==null)?"":("; domain="+this.domain))+((this.secure==true)?"; secure":"")},clearCookie:function(a){document.cookie=a+"=null; expires=Thu, 01-Jan-70 00:00:01 GMT"+((this.path==null)?"":("; path="+this.path))+((this.domain==null)?"":("; domain="+this.domain))+((this.secure==true)?"; secure":"")},decodeValue:function(a){return a},encodeValue:function(a){return a}};WIM.UI.ProductTab=function(a){Ext.apply(this,a);WIM.UI.ProductTab.superclass.constructor.call(this)};Ext.extend(WIM.UI.ProductTab,Ext.TabPanel,{activeTab:0,deferredRender:false,mask:function(){$.each(this.items.items,function(){if(this.body){this.body.unmask()}});return this.getActiveTab().el.mask(arguments[0]).j.next("div")[0]},unmask:function(){return this.getActiveTab().el.unmask()},afterRender:function(){WIM.UI.ProductTab.superclass.afterRender.call(this);W.T=this}});Ext.tree.BuddyPanel=function(){this.root=new Ext.tree.TreeNode();this.data=WIM._me;Ext.tree.TreePanel.superclass.constructor.apply(this,arguments);WIM.T.B=this;WIM.EventMgr.on([{code:WIM.Event.TYPE_ADD_BUDDY,fn:function(e,t){if(!WIM._me.hasBuddy(e.from)){var b=new WIM.Buddy({blogin:e.from,prot:e.prot});g.msgTool.on(b.getName()+"\u7487\u950b\u7730\u5a23\u8bf2\u59de\u6fc2\u85c9\u5f38",e,function(){this.newBuddy(e,b)},this)}},scope:this,sync:true},{code:WIM.Event.TYPE_REQ_ACCEPT,fn:this.acceptReq,scope:this,sync:true},{code:WIM.Event.TYPE_REQ_REJECT,fn:this.rejectReq,scope:this,sync:true},{code:WIM.Event.TYPE_STATUS_CHANGE,fn:this.stsChg,scope:this,sync:true},{code:WIM.Event.TYPE_MSG_WHISPER,fn:this.whisper,scope:this,sync:true,syncFn:function(e,t){var syncable=WIM.Bubble.isBuddyChating(e.from);if(!syncable){var b=e.getBuddy();b.speak(e.time,e.msg);var node=this.getBuddy(b).shakeHead(e);node.event=e;if(b.isOffline()){this.setStatus(b,node,WIM.Person.USER_STATUS_ONLINE)}g.msgTool.on(e.getBuddy().getName()+"\u93c9\u30e6\u79f7\u93ad\ue219\u7c21~~",e,node.chat,node)}return syncable}},{code:WIM.Event.TYPE_SIGNATURE_CHANGE,fn:function(e,t){var b=e.getBuddy();if(b){b.signature=e.msg}},scope:this,sync:true},{code:WIM.Event.TYPE_CONNECT_FROM_OTHER,fn:this.rap,scope:this,sync:true},{code:WIM.Event.TYPE_PROT_LOGIN_SUCCESS,fn:function(e,t){var tool=WIM.ToolMgr.get(e.prot);if(tool){tool.logon=true;tool.waiting=false;tool.updated=false;g.tbFooter.items.get(tool.getId()).toggleIcon();WIM._me.refreshProt(e.prot,tool.fn,tool.scope)}},sync:true},{code:WIM.Event.TYPE_DATA_NEW_GROUP,fn:function(e,t){try{WIM._me.setGroups(eval(e.msg)).each(function(i,n){this.addGroup(n,this.getRequestGroup())},this)}catch(e){}},scope:this,sync:true},{code:WIM.Event.TYPE_DATA_BUDDY_LIST,fn:function(e,t){try{eval(e.msg).each(function(i,n){n.prot=e.prot;WIM._me.getBuddy(n.blogin,n)},this);this.refresh()}catch(e){}},scope:this,sync:true},{code:WIM.Event.TYPE_DATA_BUDDY,fn:function(e,t){var b=e.getBuddy();b.updateProfile(Ext.decode(e.msg),false).updating=false;this.getBuddy(e.getBuddy()).updateName().updateTip();var p=W.Bubble.getPanel("6_"+e.from);if(p){p.refresh()}},scope:this,sync:true}])};Ext.extend(Ext.tree.BuddyPanel,Ext.tree.TreePanel,{TextNewTitle:"apply as your friend",TextAddMsg:"odditional message\u951b\ufffd",TextReject:"Reject",TextRejectReason:"reject reason",TextAccept:"Accept",TextGroup:"Selete Group",TextRejectTitle:"reject your request",TextNewGroup:"New Group",animate:false,border:false,split:true,autoWidth:true,autoHeight:true,showAll:true,afterRender:function(){Ext.tree.BuddyPanel.superclass.afterRender.call(this);this.on("contextmenu",this.showMenu,this)},showMenu:function(a){if(this.menu){a.stopEvent();this.menu.set(null).showAt(a.getXY())}},showAddWin:function(){if(WIM.UI.S){WIM.UI.S.showAddWin.call(WIM.UI.S)}},addGroup:function(f,c){var h=new Ext.tree.TreeNodeGroup({text:f.name,id:"group_"+f.id,data:f,menu:g.gMenu});var b=[];for(var a in f.BuddyList){b.push(f.BuddyList[a])}b.sort(function(j,i){return i.calcPRI()-j.calcPRI()});for(var d=0;d<b.length;d++){h.addBuddy(b[d])}(c)?this.root.insertBefore(h,c):this.root.appendChild(h)},newBuddy:function(d,c){g.msgTool.un(d);var f=WIM.Paint(["<h1><a href='javascript:void(0)'>",c.getName(),"</a>",this.TextNewTitle,"</h1>",this.TextAddMsg,"<br/><p>  ",d.msg.replace(/\r\n/g,"<br/>"),"</p><br/><br/><center><button>",this.TextAccept,"</button><button>",this.TextReject,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var a=this;$("button:first",f).click(function(){var b=new WIM.UI.Select(WIM._me.groupList,function(){return !this.isBlocked()&&!this.isRequest()});var h=WIM.Paint(["<h1><a href='javascript:void(0)'>",c.getName(),"</a>",a.TextNewTitle,"</h1><br/>",a.TextGroup,b.html(),"<center><button>",WIM.Text.OK,"</button></center>"].join(""));$("button:first",h).click(function(){var i=$("select",h).val();c.accept(i,function(){a.getGroupNodeById(i).addBuddy(c).editRemark();c.view()});WIM.Efface()})});$("button:eq(1)",f).click(function(){c.reject(prompt(a.TextRejectReason,""));WIM.Efface()});$("button:last",f).click(WIM.Efface)},acceptReq:function(f,c){var a=f.getBuddy();if(a&&!a.isOK()){a.setType(WIM.Buddy.TYPE_OK);var d=this.getBuddy(a);this.infixBuddy(d,this.getGroupNodeById(a.gid));a.view()}},rejectReq:function(b,a){alert(b.from+this.TextRejectTitle+this.TextAddMsg+"\r\n"+b.msg)},infixBuddy:function(b,d){var a=b.data.calcPRI(),c;d.eachChild(function(f){if(f.id!=b.id&&a>=f.data.calcPRI()){c=f;return false}});d.insertBefore(b,c);return b},stsChg:function(h,c){var a=h.getBuddy(),d=this.getBuddy(a),f=parseInt(h.msg);this.setStatus(a,d,f)},setStatus:function(a,d,h){if(a&&!isNaN(h)){var c=a.status;if(c==WIM.Person.USER_STATUS_OFFLINE&&h==WIM.Person.USER_STATUS_ONLINE){g.msgTool.alert(a.getName()+"\u6d93\u5a44\u568e\u6d5c\ufffd")}if(h==WIM.Person.USER_STATUS_OFFLINE){}a.setStatus(h);if(d){d.changeSts(h);var f=d.parentNode;if(f){f.refreshName();if(f.data.hasRight()||f.data.isDefault()){this.infixBuddy(d,f)}}}}},getBuddy:function(d,c){var a=typeof d=="object"?d.uid:d;var b=this.getNodeById(a);if(!b&&typeof d=="object"){b=this.getDefaultGroup().addBuddy(d)}return b},whisper:function(i,d){var c=i.getBuddy();var f=this.getBuddy(c);var a=c.speak(i.time,i.msg);f.stopShake(true);var h=WIM.Bubble.getPanel("1_"+i.from);if(h){h.addMessage(a)}},TextGroupName:"New Group Name",newGroup:function(b){var c=WIM.Paint(["<h1>",this.TextNewGroup,"</h1><input type='text' /><br/><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=new Ext.form.Field({el:$("input",c)[0],cls:"single-input",emptyText:this.TextGroupName}).render().focus();var a=this;$("button:first",c).click(function(){a.data.addGroup(b.getValue(),function(d){if(d){a.addGroup(d,a.getRequestGroup())}else{alert("\u5a23\u8bf2\u59de\u6fb6\u8fab\u89e6")}},a);WIM.Efface()});$("button:last",c).click(WIM.Efface)},getGroupNodeById:function(a){return this.getNodeById("group_"+a)},getDefaultGroup:function(){return this.data.defaultGroup.id?this.getGroupNodeById(this.data.defaultGroup.id):null},getBlockedGroup:function(){return this.data.blockedGroup.id?this.getGroupNodeById(this.data.blockedGroup.id):null},getRequestGroup:function(){return this.getGroupNodeById(this.data.requestGroup.id)},refresh:function(){while(this.root.childNodes[0]){this.root.childNodes[0].remove()}if(this.data){for(var a in this.data.groupList){var b=this.data.groupList[a];if(!b.isBlocked()&&!b.isRequest()){this.addGroup(b)}}this.addGroup(this.data.requestGroup);this.addGroup(this.data.blockedGroup)}},eachGroup:function(b,a){this.root.eachChild(b,a)},eachBuddy:function(b,a){this.eachGroup(function(c){c.eachChild(b,a)})},toggleBlock:function(b){var a=this.getBlockedGroup();if(a.hidden){a.ui.show();b.setIconClass(this.menu.selIconCls)}else{a.ui.hide();b.setIconClass("")}},toggleRequest:function(b){var a=this.getRequestGroup();if(a.hidden){a.ui.show();b.setIconClass(this.menu.selIconCls)}else{a.ui.hide();b.setIconClass("")}},toggleShowBuddy:function(a){if(this.showAll){this.showAll=false;a.setText(this.menu.TextShowAll);this.eachBuddy(function(b){if(b&&b.data.isOffline()){b.hide()}},this)}else{this.showAll=true;a.setText(this.menu.TextShowOnline);this.eachBuddy(function(b){b.show()},this)}this.eachGroup(function(){this.ui.updateExpandIcon()})},toggleBackup:function(a){if(a.iconCls==this.menu.selIconCls){a.setIconClass("");WIM.Profile.alias=false;this.eachBuddy(function(b){if(b){b.setText(b.data.getName())}},this)}else{a.setIconClass(this.menu.selIconCls);WIM.Profile.alias=true;this.eachBuddy(function(b){if(b){b.setText(b.data.getName())}},this)}},TextRap:"\u93ae\u3125\u51e1\u7f01\u5fd3\u6e6a\u934f\u6735\u7cac\u9366\u7248\u67df\u9427\u8bf2\u7d8d,\u741a\ue0a5\u63e9\u6d93\u5b2c\u568e\n\u95b2\u5d86\u67ca\u9427\u8bf2\u7d8d\u951b\ufffd",rap:function(d,a){if(d.prot==WIM.Person.PROT_DEFAULT){W.C.stop();W.Bubble.close();if(confirm(this.TextRap)){W.C.start()}else{g.close()}}else{var b=WIM.ToolMgr.get(d.prot);b.updated=b.logon=b.hide=b.waiting=false;g.tbFooter.items.get(b.getId()).logoff();var c=parseInt(d.msg);switch(c){case 3:alert("\u9422\u53d8\u7c2c"+b.name+"\u752f\u612d\u57db\u9286\ufffd"+b.plogin+"\u9286\u621d\u7611\u942e\u4f80\u654a\u7487\ufffd,\u93c3\u72b3\u7876\u9427\u8bf2\u7d8d");break;case 1:case 4:alert("\u9422\u53d8\u7c2c"+b.name+"\u93c8\u5d85\u59df\u9363\u3129\u654a\u7487\ufffd,\u7035\u8270\u56a7\u93ae\u3127\u6b91\u752f\u612d\u57db\u9286\ufffd"+b.plogin+"\u9286\u6223\ue766\u6769\ue0a1\u7b05\u7efe\ufffd");break;case 2:alert("\u93ae\u3127\u6b91"+b.name+"\u752f\u612d\u57db\u9286\ufffd"+b.plogin+"\u9286\u621d\u51e1\u9366\u3125\u53fe\u6d60\u6827\u6e74\u93c2\u572d\u6ae5\u8930\ufffd,\u93ae\u3128\ue766\u6769\ue0a1\u7b05\u7efe\ufffd");break;case 5:break;default:alert("\u93ae\u3127\u6b91"+b.name+"\u752f\u612d\u57db\u9286\ufffd"+b.plogin+"\u9286\u621d\u6e6a\u6d63\u8de8\u6564\u6769\u56e9\u25bc\u6d93\ue15e\u56ad\u941c\u677f\u56ad\u95bf\ufffd")}}}});WIM.UI.ShakeNode=Ext.extend(Ext.tree.TreeNode,{ease:25,shakeHead:function(){if(!this.shakable){this.shakable=true;this.head=$(this.ui.iconNode);if(this.parentNode&&this.parentNode.shakeHead){this.parentNode.shakeHead(this)}if(this.parentNode.expanded){this.rock()}}return this},rock:function(){var h=WIM.UI.ShakeNode.points,f,d=$(this.ui.iconNode),i=this.ease,a=true,c=0;$(this.ui.iconNode).css("position","relative");function b(){a?c++:c--;if(h[c]!=f){d.css("top",-(h[c]))}f=h[c];if(c>=h.length-1){a=false}if(c<=0){a=true}}this.shaking=setInterval(b,i)},stopShake:function(a){if(this.shaking){clearInterval(this.shaking)}if(this.head){this.head.css({top:0})}this.shakable=false;if(a&&this.parentNode.stopShake){this.parentNode.stopShake(this)}}});(function(){var d=WIM.UI.ShakeNode.points=[];var a=16,f=100*1000/25/95*2.54,c=9.8;for(var b=0;b<a;b++){d.push(c*(a*a-b*b)/2/f)}})();Ext.tree.NodeUIGroup=function(){Ext.tree.NodeUIGroup.superclass.constructor.apply(this,arguments)};Ext.extend(Ext.tree.NodeUIGroup,Ext.tree.TreeNodeUI,{cls:"wim-node-el",onTextChange:function(c,f,a){var d=c.transferText(f);var b=document.createTextNode(d);this.textNode.removeChild(this.textNode.childNodes[0]);this.textNode.appendChild(b)}});Ext.tree.TreeNodeGroup=function(a){Ext.apply(this,a);a.text=this.transferText(a.text);a.singleClickExpand=true;Ext.tree.TreeNodeGroup.superclass.constructor.call(this,a)};Ext.extend(Ext.tree.TreeNodeGroup,Ext.tree.TreeNode,{TextDelConfirm:"Confrim Delete",iconCls:"wim-tree-group",defaultUI:Ext.tree.NodeUIGroup,activeBuddy:0,singleClickExpand:true,expandable:true,render:function(a){Ext.tree.TreeNodeGroup.superclass.render.call(this,a);this.on("contextmenu",this.onContextMenu,this);this.on("expand",this.OnExpand,this);this.on("collapse",this.OnCollapse,this);this.refreshName()},removeChild:function(a){Ext.tree.TreeNodeGroup.superclass.removeChild.call(this,a);this.refreshName()},rename:function(c){var d=WIM.Paint(["<h1>",c.text,this.text,"</h1><input type='text' /><br/><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=new Ext.form.Field({el:$("input",d)[0],cls:"single-input",selectOnFocus:true,value:this.text}).render().focus();var a=this;$("button:first",d).click(function(){a.data.rename(b.getValue(),function(){WIM.Efface();a.setText(b.getValue())})});$("button:last",d).click(WIM.Efface)},addBuddy:function(a){var c=this.newBuddy(a);if(this.rendered){this.infixBuddy(c)}else{this.appendChild(c)}this.refreshName();return c},newBuddy:function(a){return new WIM.UI.NodeBuddy({text:a.getName(),id:a.uid,menu:g.bMenu,data:a})},infixBuddy:function(a){return this.ownerTree.infixBuddy(a,this)},edit:function(){WIM.Bubble.EditPref(this.data)},onContextMenu:function(a,b){if(this.menu){b.stopEvent();this.menu.set(this).showAt(b.getXY());this.select()}},changeName:function(a){this.setText(a);this.data.rename(a)},transferText:function(a){return a+="  ["+this.data.onlines+"/"+this.data.total()+"]"},removeCfm:function(){if(confirm(this.TextDelConfirm+"\u9286\ufffd"+this.text+"\u9286\ufffd")){this.data.remove();this.data=null;var a=this.ownerTree.getDefaultGroup();this.remove();if(a){a.refresh()}}},refresh:function(){this.removeAll();var b=this.data;for(var a in b.BuddyList){this.addBuddy(b.BuddyList[a])}},removeAll:function(){while(this.childNodes[0]){this.childNodes[0].remove()}},shakes:[],shakeHead:function(d){if(d){this.shakes.push(d)}if(!this.shaking&&this.shakes.length>0){var h=false,c=this.ui.textNode,b=c.innerHTML,a=this,f=$(c);this.shaking=setInterval(function(){log.debug("_self.expanded = "+a.expanded);if(!a.expanded){log.debug("blank = "+h);if(h){f.text(b);h=false}else{f.text("\u9286\ufffd");h=true}}},500)}},OnExpand:function(){this.refreshName();for(var a=0;a<this.shakes.length;a++){this.shakes[a].rock()}if(this.shaking){clearInterval(this.shaking);delete this.shaking}},OnCollapse:function(){for(var a=0;a<this.shakes.length;a++){this.shakes[a].stopShake()}if(this.shakes.length>0){this.shakeHead()}},stopShake:function(a){this.shakes.remove(a);if(this.shaking&&this.shakes.length==0){clearInterval(this.shaking);delete this.shaking}this.refreshName()},refreshName:function(){this.setText(this.data.name)}});WIM.UI.NodeUIBuddy=function(){WIM.UI.NodeUIBuddy.superclass.constructor.apply(this,arguments)};Ext.extend(WIM.UI.NodeUIBuddy,Ext.tree.TreeNodeUI,{setIconCls:function(a){$(this.iconNode).attr("class","x-tree-node-icon "+a)},effectOnline:function(){var a=$(this.elNode);$("<div/>").prependTo(a).css({position:"absolute",color:"gray",left:10}).text(a.text()).animate({fontSize:"8em",opacity:"hide"},{complete:function(){$(this).remove()},duration:500})}});WIM.UI.NodeBuddy=function(a){Ext.apply(this,a);a.tipContent=this.data.signature.slice(0,100);WIM.UI.NodeBuddy.superclass.constructor.call(this,a);this.on("contextmenu",this.showMenu,this);this.on("dblclick",this.chat,this);this.on("move",this.OnMove,this)};Ext.extend(WIM.UI.NodeBuddy,WIM.UI.ShakeNode,{TextDelCfm:"Confirm delete",TextRemark:"Change Alias",cls:"wim-buddy-node",defaultUI:WIM.UI.NodeUIBuddy,allowChildren:false,preIconCls:"nopre",chat:function(){this.stopShake(true);if(this.event){g.msgTool.un(this.event);delete this.event}W.Bubble.BuddyChat(this.data)},render:function(){WIM.UI.NodeBuddy.superclass.render.call(this);this.changeSts()},unblock:function(){this.data.unblock();var a=this.getOwnerTree();this.remove();a.getGroupNodeById(this.data.gid).addBuddy(this.data)},block:function(){this.data.block();var a=this.getOwnerTree();this.remove();a.getGroupNodeById(WIM._me.blockedGroup.id).addBuddy(this.data)},lookPref:function(){W.Bubble.LookPref(this.data.view())},updateTip:function(a){this.ui.setTipContent((a||this.data.signature).slice(0,50));return this},updateName:function(){this.setText(this.data.getName());return this},showMenu:function(a,b){if(this.menu){b.stopEvent();this.menu.set(this).showAt(b.getXY());a.select();return false}},OnMove:function(a,d,b,c){if(b!=c){this.data.updateGroup(c.data.id)}},moveBuddy:function(h){var f=h.data,d=h.parentMenu.node,c=d.data,a=d.getOwnerTree();(f.isBlocked())?c.block():c.updateGroup(f.id);d.remove();a.getGroupNodeById(f.id).addBuddy(c)},removeBuddy:function(){this.menu.hide();if(confirm(this.TextDelCfm+"\u9286\ufffd"+this.data.getName()+"\u9286\ufffd")){this.data.remove();this.remove()}},hide:function(){this.data.hide=true;this.ui.hide()},show:function(){this.data.hide=false;this.ui.show()},editRemark:function(){var c=WIM.Paint(["<h1>",this.TextRemark,"</h1><input type='text' /><br/><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=new Ext.form.Field({el:$("input",c)[0],cls:"single-input",selectOnFocus:true,value:this.data.profile.remark||""}).render().focus();var a=this;$("button:first",c).click(function(){if(b.getValue().trim().length==0){WIM.Efface()}a.data.updateProfile({remark:b.getValue()},function(){WIM.Efface();a.setText(b.getValue())})});$("button:last",c).click(WIM.Efface)},changeSts:function(a){a=a===undefined?this.data.status:a;if(a==WIM.Person.USER_STATUS_OFFLINE){this.ui.setIconCls(this.data.getTool().iconClsOff)}else{this.ui.setIconCls(this.data.getTool().iconCls)}return this}});Ext.tree.QunPanel=function(){this.root=new Ext.tree.TreeNode();this.data=WIM._me;Ext.tree.TreePanel.superclass.constructor.apply(this,arguments);WIM.EventMgr.on([{code:WIM.Event.TYPE_QUN_KICK_OUT,fn:function(c,a){var b=c.getQun();if(b){this.delQun(c.chatId);alert("\u93ae\u3128\ue766"+c.from+"\u6d60\ufffd"+b.name+"\u7f07\u3084\u8151\u7ec9\u5a5a\u6ace\u6d5c\ufffd.")}},scope:this,sync:true},{code:WIM.Event.TYPE_QUN_INVITE,fn:function(c,a){if(!this.getNodeById(c.chatId)){var b=new W.Qun({id:c.chatId});b.select(function(){if(confirm("\u93ae\u3125\u6093\u93b0\u5fda\ue766"+c.from+"\u95ad\ufffd\u7487\u5cf0\u59de\u934f\u30e7\u5162["+b.name+"]\u935a\u694b\u7d35")){W._me.addQunData(b);this.addQun(b)}},this)}},scope:this,sync:true},{code:WIM.Event.TYPE_MSG_QUN,fn:function(h,b){var d=h.getQun(),c=this.getNodeById(h.chatId);if(c){var a=d.speak(h.from,h.time,h.msg);c.stopShake();var f=WIM.Bubble.getPanel("2_"+h.chatId);if(f){f.addMessage(a)}}},scope:this,sync:true,syncFn:function(f,a){var c=WIM.Bubble.isQunChating(f.chatId);if(!c){var d=f.getQun();if(d){d.speak(f.from,f.time,f.msg);var b=this.getQunNodeById(f.chatId).shakeHead(f);b.event=f;g.msgTool.on("["+d.name+"] room has messages",f,b.sendMsg,b)}}return c}}])};Ext.extend(Ext.tree.QunPanel,Ext.tree.TreePanel,{TextNewQun:"New Room",TextName:"Room Name:",TextDesc:"Description",border:false,autoWidth:true,style:{height:"100%"},afterRender:function(){Ext.tree.QunPanel.superclass.afterRender.call(this);this.on("contextmenu",this.onContextMenu,this)},onContextMenu:function(a){if(this.menu){a.preventDefault();this.menu.set(null).showAt(a.getXY())}},addQun:function(a){var b=new Ext.tree.TreeNodeQun({text:a.name,id:a.id,menu:g.qMenu,data:a});this.root.appendChild(b)},delQun:function(b){if(W.Bubble.isOpen()){W.Bubble.remove("2_"+b);W.Bubble.remove("5_"+b)}this.data.qunList[b].deleteQun();var a=this.getNodeById(b);if(a){a.remove()}},newQun:function(b){var d=WIM.Paint(["<h1>",this.TextNewQun,"</h1><label>",this.TextName,"</label><input type='text' /><br/><textarea></textarea><br/><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=new Ext.form.Field({el:$("input",d)[0],cls:"single-input"}).render().focus();var c=new Ext.form.Field({el:$("textarea",d)[0],emptyText:this.TextDesc}).render();var a=this;$("button:first",d).click(function(){a.data.createQun(b.getValue(),c.getValue(),function(f){a.addQun(f)},a);WIM.Efface()});$("button:last",d).click(WIM.Efface)},getQunNodeById:function(a){return this.getNodeById(a)},refresh:function(){while(this.root.childNodes[0]){this.root.childNodes[0].remove()}if(this.data){for(var a in this.data.qunList){this.addQun(this.data.qunList[a])}}},eachQun:function(b,a){this.root.eachChild(b,a)}});Ext.tree.TreeNodeQun=Ext.extend(WIM.UI.ShakeNode,{cls:"wim-qun-node",iconCls:"wim-qun-icon",TextQuit:"Are you sure to exit?",TextAban:"Are you sure to dismiss?",render:function(a){Ext.tree.TreeNodeQun.superclass.render.call(this,a);this.on("dblclick",this.sendMsg,this);this.on("contextmenu",this.onMenu,this)},onMenu:function(a,b){if(this.menu){b.stopEvent();this.menu.set(this).showAt(b.getXY());this.select()}},sendMsg:function(){this.stopShake();if(this.event){g.msgTool.un(this.event)}W.Bubble.QunChat(this.data)},abandon:function(){if(confirm(this.TextAban+this.data.name+"?")){this.data.remove();this.remove()}},joinType:function(a){this.data.update({joinType:a.value})},visiType:function(a){this.data.update({visiType:a.value})},rename:function(c,d){var f=WIM.Paint(["<h1>",c.text,this.text,"</h1><input type='text' /><br/><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=new Ext.form.Field({el:$("input",f)[0],selectOnFocus:true,cls:"single-input",value:this.text}).render().focus();var a=this;$("button:first",f).click(function(){a.data.rename(b.getValue(),function(){WIM.Efface();a.setText(b.getValue())})});$("button:last",f).click(WIM.Efface)},block:function(){},unblock:function(){},quit:function(){if(confirm(this.TextQuit+this.data.name+"?")){this.data.quit();this.remove()}},memberMgr:function(){WIM.Bubble.MemberMgr(this.data,WIM._me)}});WIM.UI.FloatToolbar=function(a){Ext.apply(this,a);this.floatBtn=new WIM.UI.FloatButton({handler:this.clickFltBtn,scope:this});this.items=[this.floatBtn];WIM.UI.FloatToolbar.superclass.constructor.call(this,a)};Ext.extend(WIM.UI.FloatToolbar,Ext.Toolbar,{calcWidth:40,calcHeight:1.5,cls:"wim-ftbar",hideParent:true,initComponent:function(){WIM.UI.FloatToolbar.superclass.initComponent.call(this);this.addEvents("mouseover","mouseout")},hangupTrees:function(){for(var a=0;a<arguments.length;a++){if(arguments[a]&&arguments[a].on){arguments[a].on("mouseover",this.onNodeOver,this)}}g.tab.on("tabchange",this.onNodeOut,this)},clickFltBtn:function(a,b){b.preventDefault();b.stopEvent();this.node.fireEvent("contextmenu",this.node,b)},onNodeOver:function(a,d){if(this.node!=a){this.node=a;var f=$(a.ui.elNode).offset(),c=f.top-this.calcHeight,b=a.ownerTree.container.getWidth()-this.calcWidth+f.left;this.setPosition(b,c).show()}},onNodeOut:function(a){this.hide();this.node=null}});WIM.UI.FloatButton=function(a){Ext.apply(this,a);WIM.UI.FloatButton.superclass.constructor.call(this,a)};Ext.extend(WIM.UI.FloatButton,Ext.Toolbar.Button,{iconCls:"wim-tool-group-icon",width:24});WIM.UI.FilterMenu=function(a){WIM.Apply(this,a);this.defaults={scope:this,handler:this.handleClick};WIM.UI.FilterMenu.superclass.constructor.call(this,a)};Ext.extend(WIM.UI.FilterMenu,Ext.menu.Menu,{selIconCls:"wim-reply-select",shows:[],handleClick:function(a){if(this.node&&a.method&&typeof this.node[a.method]=="function"){this.node[a.method](a,this)}},set:function(a){if(a){this.node=a;this.filter();this.clickNode()}else{this.node=null;this.filter();this.clickBlank()}this.hateDouble();return this},clickNode:function(){},clickBlank:function(){},filter:function(){this.shows=[];var s=this.items.items.each(function(i,n){if(typeof n.filter=="string"){try{eval("var show = "+n.filter)}catch(e){}if(!show){n.hide();return}}n.show();this.shows.push(n)},this)},hateDouble:function(){var a=0;while(this.shows[a++].constructor==Ext.menu.Separator){this.hideSepatator(a-1)}for(;a<this.shows.length;a++){if(this.shows[a-1].constructor==Ext.menu.Separator&&this.shows[a].constructor==Ext.menu.Separator){this.hideSepatator(a-1)}}this.hideSepatator(this.shows.length-1)},hideSepatator:function(a){var b=this.shows[a];if(b&&!b.hidden&&b.constructor==Ext.menu.Separator){b.hide()}}});Ext.Toolbar.ToolButton=function(b){WIM.Apply(this,b);b.iconCls=b.data.useable?b.data.iconCls:b.data.iconClsOff;this.id=b.data.id;this.menu=new WIM.UI.ProtMenu();this.tipContent=b.data.name;Ext.Toolbar.ToolButton.superclass.constructor.call(this,b)};Ext.extend(Ext.Toolbar.ToolButton,Ext.Toolbar.Button,{TextBind:"Bind",TextUnBind:"Unbind",TextHide:"Hide",TextShow:"Show",UrlBind:"bindWin.html",nameBind:"bindWin",UrlUnbind:"unbindWin.html",nameUnbind:"unbindWin",clsLoading:"tool-loading",bind:function(){WIM.WinMgr.add(this.UrlBind,this.nameBind+this.data.id,undefined,{prot:this.data.name,fn:function(b,a){this.loading();WIM._me.bindProt(this.data.id,b,a,this.refresh,this,true)},scope:this})},refresh:function(){delete this.data.fn;delete this.data.scope;this.panel.refresh();this.toggleIcon()},unbind:function(){WIM.WinMgr.add(this.UrlUnbind,this.nameUnbind+this.data.id,undefined,{prot:this.data.name,name:this.data.plogin,fn:function(){WIM._me.logoutProt(this.data.id,function(){WIM._me.removeProt(this.data.id,this.refresh,this)},this)},scope:this})},hide:function(){this.panel.eachBuddy(function(a){if(a&&a.data.prot==this.data.id){a.hide();if(!a.data.isOffline()&&a.data.getColletion()){a.data.getColletion().onlines--}}},this)},show:function(){this.panel.eachBuddy(function(a){if(a&&a.data.prot==this.data.id){if(!a.data.isOffline()&&a.data.getColletion()){a.data.getColletion().onlines++}a.show()}},this)},toggleDisplay:function(){if(this.data.hide){this.data.hide=false;this.show()}else{this.data.hide=true;this.hide()}this.panel.eachGroup(function(a){a.ui.updateExpandIcon();a.refreshName()})},showMenu:function(){if(this.menu){this.menu.set(this).show(this.el,this.menuAlign)}return this},toggleIcon:function(){this.setIconClass(this.data.logon?this.data.iconCls:this.data.iconClsOff)},active:function(){this.data.useable=true;this.toggleIcon()},login:function(){this.loading();WIM._me.getBuddyList(this.data.id,this.data.plogin,0,this.refresh,this)},loading:function(){this.setIconClass(this.clsLoading)},logoff:function(){WIM._me.logoutProt(this.data.id,this.refresh,this)},TextUpdate:"loading data from server, please wait...",update:function(){WIM._me.refreshProt(this.data.id,function(){alert(this.TextUpdate)},this)}});WIM.UI.ProtMenu=function(a){this.items=[{text:this.TextHide,method:"toggleDisplay",filter:"this.node.data.useable && !this.node.data.hide"},{text:this.TextShow,method:"toggleDisplay",filter:"this.node.data.useable && this.node.data.hide"},"-",{text:this.TextUpdate,method:"update",filter:"this.node.data.hasRight() && this.node.data.logon && !this.node.data.updated"},{text:this.TextLogin,method:"login",filter:"this.node.data.hasRight() && !this.node.data.logon"},{text:this.TextLogoff,method:"logoff",filter:"this.node.data.hasRight() && this.node.data.logon"},{text:this.TextBind,method:"bind",filter:"!this.node.data.isDefault() && !this.node.data.useable"},{text:this.TextUnBind,method:"unbind",filter:"this.node.data.hasRight()"}];WIM.UI.ProtMenu.superclass.constructor.call(this,a)};Ext.extend(WIM.UI.ProtMenu,WIM.UI.FilterMenu,{TextBind:"Bind",TextUnBind:"Unbind",TextHide:"Hide",TextShow:"Show",TextLogin:"Login",TextLogoff:"Logout",TextUpdate:"Update"});WIM.UI.MoodField=function(a){Ext.apply(this,a);WIM.UI.MoodField.superclass.constructor.call(this);this.render();this.on("focus",this.moodFocus,this);this.on("blur",this.moodBlur,this);this.on("change",this.moodChange,this);this.on("specialkey",this.onEnter,this)};Ext.extend(WIM.UI.MoodField,Ext.form.Field,{emptyText:"you have no sign now\u9225\ufe39\ufffd\ufffd",coverCls:"wim-noborder",cls:"wim-noborder h-status",overClass:"h-status-over",whiteCls:"whiteCls",selectOnFocus:true,tipContent:"Change sign",moodFocus:function(){$(this.el.dom).removeAttr("readonly").removeClass(this.coverCls).addClass(this.whiteCls).select().focus()},moodBlur:function(){$(this.el.dom).attr("readonly","readonly").removeClass(this.whiteCls).addClass(this.coverCls)},moodChange:function(c,b){var a=this;WIM._me.changeMood(b)},onEnter:function(a,b){if(b.ENTER){this.el.dom.blur()}}});WIM.UI.SearchField=function(a){Ext.apply(this,a);WIM.UI.SearchField.superclass.constructor.call(this);this.render();this.on("keyup",this.query,this);this.on("render",this.createRet,this);this.on("specialkey",this.keynav,this);this.addEvents("click");this.on("click",this.onClick,this)};Ext.extend(WIM.UI.SearchField,Ext.form.Field,{width:200,height:22,emptyText:"search your friends",queryDelay:100,delay:200,chars:1,limit:10,hoverCls:"sh-list-hd",retCls:"wim-search-ret",curPos:null,onClick:function(a){var f=g.buddyPanel.getNodeById(WIM._me.buddyList[a].uid);if(f){g.tab.activate(0);f.show();f.parentNode.expand();var i=g.buddyPanel.el.j,k=f.ui.wrap,b=g.buddyPanel.el.getHeight(),c=k.offsetTop;var j=$.support.boxModel?130:230;i.animate({scrollTop:k.offsetTop-b+j},600);f.select()}},query:function(){var a=this.getValue();if(this.isChange()){this.catchOne=false;if(this.police){clearTimeout(this.police)}}if(a.length>=this.chars&&this.isChange()){this.police=this.searchBuddy.defer(this.delay,this,[a])}else{this.hideRet()}return true},searchBuddy:function(a){a=a.toLocaleLowerCase();function c(d,f){if(f){return(f+"").toLocaleLowerCase().indexOf(d)>-1}return false}var b=WIM._me.findBuddyFn(function(d){return c(a,d.name)||c(a,d.blogin)||c(a,d.profile.name)||c(a,d.profile.remark)});if(b.length>0){this.showRet(b)}else{this.hideRet()}},hideRet:function(){this.open=false;if(this.jRet){this.jRet.hide(500)}},blurHandle:function(){this.hideRet();if(!this.catchOne){this.setValue("")}},showRet:function(a){if(!this.jRet){this.createRet()}this.open=true;if(a.length>this.limit){a=a.slice(0,this.limit)}this.jRet.empty();a.each(function(b,c){this.jRet.append(this.initLi(c))},this);this.jRet.show(500)},keynav:function(a,b){if(this.open){switch(b.getKey()){case b.DOWN:this.updatePos((this.curPos&&this.curPos[0].nextSibling)||this.jRet.children("li:first"));break;case b.UP:this.updatePos(this.curPos?(this.curPos[0].previousSibling)||this.jRet.children("li:last"):this.jRet.children("li:first"));break;case b.ENTER:this.addBuddy();break}}else{if(b.getKey()==b.ENTER&&this.catchOne){this.affirm(this.catchOne.data("bid"))}}},affirm:function(a){WIM.Bubble.BuddyChat(WIM._me.buddyList[a])},addBuddy:function(){if(this.curPos&&this.curPos.data("bid")){this.catchOne=this.curPos;this.hideRet();this.setValue(this.curPos.text());this.fireEvent("click",this.curPos.data("bid"))}},updatePos:function(a){a=$(a);if(a&&a.length>0){if(this.curPos){this.curPos.removeClass(this.hoverCls)}this.curPos=a;this.curPos.addClass(this.hoverCls)}},initLi:function(c){var a=this;return $(["<li><img unselectable='on' src='",Ext.BLANK_IMAGE_URL,"' class='",c.getCls(),"'/><b>",c.getName(),"</b>(",c.blogin,")</li>"].join("")).data("bid",c.id).mouseover(function(){a.updatePos($(this))}).click(function(){a.addBuddy()})},createRet:function(){var a=$(this.el.dom);this.jRet=$("<ul/>").hide().addClass(this.retCls).width(a.outerWidth()-2).insertAfter(a)}});WIM.UI.Select=function(b,a){this.init(b,a)};Ext.extend(WIM.UI.Select,Ext.util.Observable,{init:function(c,b){var a=$("<select/>");$.each(c,function(){if(!b||(b&&b.call(this))){$("<option/>").val(this.id||this.value||this[1]).text(this.name||this.text||this[0]).appendTo(a)}});return this.select=a},html:function(){return"<select>"+(this.select?this.select.html():"")+"</select>"},val:function(a){this.select.val(a)},disable:function(){return this.select.attr("disabled","disabled")}});WIM.UI.SelectMgr=function(){var a=[];return{on:function(c,b){var d={l:c,fn:b};a.push(d);return this.create(d)},create:function(c){var b=[];$.each(c.l,function(f,d){if(c.fn&&c.fn.call(d)){b.push([this.name,this.id])}});return new WIM.UI.Select(b)},get:function(b){$.each(a,function(c,d){if(b==d.l){this.create(d)}})}}}();WIM.UI.TabPanel=function(a){Ext.apply(this,a);WIM.UI.TabPanel.superclass.constructor.call(this)};Ext.extend(WIM.UI.TabPanel,Ext.TabPanel,{mask:function(){$.each(this.items.items,function(){if(this.body){this.body.unmask()}});return this.getActiveTab().body.mask(arguments[0]).next("div",true)},unmask:function(){return this.getActiveTab().body.unmask()}});WIM.UI.SettingButton=function(a){Ext.apply(this,a);this.replyMenu=new Ext.menu.ReplyMenu({tabs:this.tabs});this.menu=[{text:g.gMenu.TextShowOnline,handler:g.buddyPanel.toggleShowBuddy,scope:g.buddyPanel},"-",{text:this.TextAdd,handler:this.showAddWin,scope:this},{text:this.TextPref,handler:function(){WIM.Bubble.EditPref(WIM._me.defaultGroup)}},{text:this.TextReply,menu:this.replyMenu},"-",{text:this.TextReport,handler:this.report,scope:this},{text:this.TextLogout,handler:g.close}];WIM.UI.SettingButton.superclass.constructor.call(this);WIM.UI.S=this};Ext.extend(WIM.UI.SettingButton,Ext.Toolbar.Button,{text:"Setting",TextAdd:"Add Friend",TextFind:"Find",TextPref:"My Profile",TextReply:"Auto-Reply",TextTool:"Tool:",TextName:"Name:",TextGroup:"Group:",TextAlert:"Input Name",TextReport:"Question&Feedback",TextLogout:"Logout",showAddWin:function(k,j,m,n){var d=[],f=[];WIM.ToolMgr.each(function(){if(this.useable){d.push([this.name,this.id])}});$.each(WIM._me.groupList,function(){if(!(this.isBlocked()||this.isRequest())){f.push([this.name,this.id])}});var i=WIM.Paint(["<h1>",this.TextAdd,"</h1><label>",this.TextTool,"</label>",new WIM.UI.Select(d).html(),"<br/><label>",this.TextName,"</label><input type='text' /><br/><label>",this.TextGroup,"</label>",new WIM.UI.Select(f).html(),"<br/><textarea></textarea><br/><center><button>",WIM.Text.Add,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var c=new Ext.form.Field({el:$("input",i)[0],emptyText:m}).render();if(m){c.disable()}var l=new Ext.form.Field({el:$("textarea",i)[0],emptyText:"message"}).render();var p=$("select:first",i);if(n!==undefined){p.val(n);p.attr("disabled","disabled")}var h=this;$("button:first",i).click(function(){if(c.getValue().length==0){alert(h.TextAlert);c.focus();return}WIM._me.addBuddy(p.val(),c.getValue(),$("select:last",i).val(),l.getValue(),function(q,a){WIM.Efface();if(q.length==0){WIM.T.B.getGroupNodeById(WIM._me.requestGroup.id).addBuddy(a)}},h)});$("button:last",i).click(WIM.Efface);self.focus()},report:function(){var c=WIM.Paint(["<h1>",this.TextReport,"</h1>","<label>Contact:</label><input type='text'/><br/><textarea></textarea><br/><center><button>",WIM.Text.OK,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var a=new Ext.form.Field({el:$("input",c)[0]}).render().focus();var b=new Ext.form.Field({el:$("textarea",c)[0]}).render();$("button:first",c).click(function(){if(b.getValue()!=""){WIM._service.submitFeedback([WIM._me.id,WIM._me.secret,a.getValue(),b.getValue()])}WIM.Efface()});$("button:last",c).click(WIM.Efface)}});Ext.menu.ReplyMenu=function(a){Ext.apply(this,a);this.items=[{text:this.TextAdd,handler:function(){var c=WIM.Paint(["<h1>",this.TextAdd,"</h1><textarea></textarea><br/><center><button>",WIM.Text.New,"</button><button>",WIM.Text.Cancel,"</button></center>"].join(""));var b=this;$("button:first",c).click(function(){var d=$("textarea",c).val();if(d.length==0){alert(b.TextAlert);$("textarea",c).focus();return}WIM.Efface();b.clickReply(b.addReply({text:d}));WIM._me.autoReply(d,true)});$("button:last",c).click(WIM.Efface)},scope:this},"-"];Ext.menu.ReplyMenu.superclass.constructor.call(this)};Ext.extend(Ext.menu.ReplyMenu,Ext.menu.Menu,{TextAdd:"Add auto-reply",TextAlert:"please input content...",ReplyIconCls:"wim-reply-select",initReply:function(a){return{text:a.text,iconCls:a.checked?this.ReplyIconCls:"",handler:this.clickReply,scope:this}},addReply:function(a){return this.addMenuItem(this.initReply(a))},clickReply:function(a){if(a.iconCls==this.ReplyIconCls){WIM._me.autoReply(a.text,false);a.setIconClass("")}else{WIM._me.autoReply(a.text,true);if(this.selected){this.selected.setIconClass("")}(this.selected=a).setIconClass(this.ReplyIconCls)}}});WIM.UI.StatuButton=function(a){Ext.apply(this,a);WIM.UI.StatuButton.superclass.constructor.call(this)};Ext.extend(WIM.UI.StatuButton,Ext.Button,{cls:"x-btn-icon",setStatus:function(a){if(this.selected!=a.sid){WIM._me.changeStatus(this.selected=a.sid);this.setIconClass(a.iconCls)}},initComponent:function(){this.iconCls=WIM._me.getStatus().iconCls;this.selected=WIM._me.getStatus().sid;var b=[];for(var a in this.data){this.data[a].handler=this.setStatus;this.data[a].scope=this;b.push(this.data[a])}this.menu=b;WIM.UI.StatuButton.superclass.initComponent.call(this)}});WIM.UI.HeaderToolbar=function(a){Ext.apply(this,a);WIM.UI.HeaderToolbar.superclass.constructor.call(this);this.btnSts=new WIM.UI.StatuButton({data:WIM.Person.StatusMap});this.add(this.btnSts);this.nameField=$("<span>").text(WIM._me.getName());this.add(this.nameField[0]);if(!g.isWin){this.btnOut=$("<a href='javascript:void(0)'/>").attr("title",this.TextPop).addClass("h-pop").click(function(){WIM.Paint(g.TextList);WIM.C.stop();WIM.Bubble.openChatWindow(function(){WIM.Bubble.prepareData()})});this.add("->",this.btnOut[0])}};Ext.extend(WIM.UI.HeaderToolbar,Ext.Toolbar,{hideParent:true,cls:"wim-header-top",TextPop:"Pop Chating Window",setName:function(a){this.nameField.text(a)}});WIM.UI.BuddyMenu=function(a){this.items=[{text:this.TextUnBlock,method:"unblock",filter:"this.node.data.isBlocked()"},{text:this.TextSendMsg,method:"chat",filter:"this.node.data.isOK()"},"-",{text:this.TextRemark,method:"editRemark",filter:"this.node.data.isOK()"},{text:this.TextLookProf,method:"lookPref"},"-",{text:this.TextDel,method:"removeBuddy"},{text:this.TextBlock,method:"block",filter:"this.node.data.isOK()"},{text:this.TextMove,id:this.groupId,menu:this.initGroup(true)}];WIM.UI.BuddyMenu.superclass.constructor.call(this,a);this.gitem=this.items.get(this.groupId)};Ext.extend(WIM.UI.BuddyMenu,WIM.UI.FilterMenu,{TextRemark:"Change Alias",TextSendMsg:"Send Message",TextMove:"Move Buddy To",TextBlock:"Add To Block",TextLookProf:"View Profile",TextDel:"Delete Buddy",TextChatRec:"View Chat Record",TextUnBlock:"Add Buddy",TextAccept:"Accept Request",TextReject:"Reject Request",groupId:"wim_gmenu",clickNode:function(){this.initGroup();this.chkGroup()},chkGroup:function(){var c=this.node.parentNode.data;if(c.isBlocked()||c.isRequest()){this.gitem.hide()}else{this.movemenu.node=this.node;var a=this,b=true;this.movemenu.items.items.each(function(d,f){if(f.data.id==this.node.data.gid){f.hide()}else{f.show();b=false}},this);b?this.gitem.hide():this.gitem.show()}},initGroup:function(b){if(b||WIM._me.groupChanged){WIM._me.groupChanged=false;if(this.movemenu){this.movemenu.removeAll()}else{this.movemenu=new Ext.menu.Menu({defaults:{scope:this,handler:this.handleClick,method:"moveBuddy"}})}for(var a in WIM._me.groupList){var c=WIM._me.groupList[a];if(!c.isBlocked()&&!c.isRequest()){this.movemenu.add({text:c.name,data:c})}}return this.movemenu}}});WIM.UI.GroupMenu=function(a){this.tree=a.tree;this.items=[{text:this.TextAddGroup,filter:"this.node",handler:this.tree.newGroup,scope:this.tree},{text:this.TextAddBuddy,filter:"this.node",handler:this.tree.showAddWin,scope:this.tree},"-",{text:this.TextEditPref,filter:"this.node && (this.node.data.hasRight() || this.node.data.isDefault())",method:"edit"},{text:this.TextRename,filter:"this.node && this.node.data.hasRight()",method:"rename"},{text:this.TextDelGroup,filter:"this.node && this.node.data.hasRight()",method:"removeCfm"},"-",{text:this.TextShowOnline,filter:"!this.node",handler:this.tree.toggleShowBuddy,scope:this.tree},{text:this.TextShowBackup,filter:"!this.node",handler:this.tree.toggleBackup,iconCls:this.selIconCls,scope:this.tree},"-",{text:this.TextBlockG,filter:"!this.node",handler:this.tree.toggleBlock,iconCls:this.selIconCls,scope:this.tree},{text:this.TextRequestG,filter:"!this.node",handler:this.tree.toggleRequest,iconCls:this.selIconCls,scope:this.tree}];WIM.UI.GroupMenu.superclass.constructor.call(this,a);this.tree.menu=this};Ext.extend(WIM.UI.GroupMenu,WIM.UI.FilterMenu,{TextAddGroup:"New Group",TextRename:"Rename",TextDelGroup:"Delete Group",TextAddBuddy:"Add Friend",TextShowOnline:"Show Onlines",TextShowAll:"Show All",TextEditPref:"Edit Profile",TextBlockG:"Show Blocked",TextRequestG:"Show Requested",TextShowBackup:"Show Alias"});WIM.UI.QunMenu=function(a){this.tree=a.tree;this.items=[{text:this.TextMsg,filter:"this.node",method:"sendMsg"},"-",{text:this.TextAdd,handler:this.tree.newQun,scope:this.tree},{text:this.TextRename,filter:"this.node && this.node.data.hasRight()",method:"rename"},{text:this.TextBlock,filter:"false",method:"block"},{text:this.TextUnblock,filter:"false",method:"unblock"},{text:this.TextChat,filter:"false"},{text:this.TextLook,filter:"false"},{text:this.TextEdit,filter:"false"},{text:this.TextJoin,filter:"this.node && this.node.data.hasRight()",menu:this.initJoinMenu()},{text:this.TextVisi,filter:"this.node && this.node.data.hasRight()",menu:this.initVisiMenu()},{text:this.TextMgr,method:"memberMgr",filter:"this.node && this.node.data.hasRight()"},"-",{text:this.TextQuit,filter:"this.node && !this.node.data.isOwner()",method:"quit"},{text:this.TextAbandon,filter:"this.node && this.node.data.isOwner()",method:"abandon"}];WIM.UI.QunMenu.superclass.constructor.call(this,a);this.tree.menu=this};Ext.extend(WIM.UI.QunMenu,WIM.UI.FilterMenu,{TextMsg:"Send Message",TextAdd:"New Room",TextRename:"Rename",TextAbandon:"Dismiss",TextMgr:"Manage Member",TextEdit:"Edit Profile",TextLook:"View Profile",TextQuit:"Exit Room",TextChat:"View Chat Record",TextBlock:"Receive Message",TextUnblock:"Block Message",TextJoin:"Join Type",TextFree:"Join Free",TextMgrOnly:"Manager Approve",TextApprove:"Need Approve",TextCommnad:"Introduce",TextVisi:"Visit Type",TextPrivate:"Private",TextSummary:"Subject",TextPublic:"Public",initSubMenu:function(b,c){var a=[];b.each(function(d,f){a.push({text:f[1],value:f[0],method:c,tipContent:f[2]})});return new Ext.menu.Menu({defaults:{scope:this,handler:this.handleClick},items:a})},initJoinMenu:function(){return this.joinMenu=this.initSubMenu([[WIM.Qun.JOIN_FREE,this.TextFree,""],[WIM.Qun.JOIN_MANAGER_ONLY,this.TextMgrOnly,""],[WIM.Qun.JOIN_NEED_APPROVE,this.TextApprove,""]],"joinType")},initVisiMenu:function(){return this.visiMenu=this.initSubMenu([[WIM.Qun.VISI_PRIVATE,this.TextPrivate,""],[WIM.Qun.VISI_SUMMARY,this.TextSummary,""],[WIM.Qun.VISI_PUBLIC,this.TextPublic,""]],"visiType")},resetSubMenu:function(b,a){b.items.each(function(c){if(a==c.value){c.setIconClass(this.selIconCls)}else{c.setIconClass("")}},this)},clickNode:function(){if(this.node.data.hasRight()){this.resetSubMenu(this.joinMenu,this.node.data.joinType);this.resetSubMenu(this.visiMenu,this.node.data.visiType)}}});WIM.UI.SoundButton=function(a){Ext.apply(this,a);WIM.UI.SoundButton.superclass.constructor.call(this)};Ext.extend(WIM.UI.SoundButton,Ext.Button,{cls:"x-btn-icon",iconCls:"wim-sound-normal",normCls:"wim-sound-normal",winkCls:"wim-sound-wink",TextAuto:"Auto",TextDefault:"Manual",initComponent:function(){WIM.UI.StatuButton.superclass.initComponent.call(this)},wink:function(b,a){this.setIconClass(this.winkCls)},close:function(){this.setIconClass(this.normCls)}});WIM.UI.MsgToolbar=function(a){Ext.apply(this,a);WIM.UI.MsgToolbar.superclass.constructor.call(this);this.render();this.btnSound=new WIM.UI.SoundButton();this.add(this.btnSound);this.msg=$("<a href='javascript:void(0)'/>").text(this.TextWelcome);this.add(this.msg[0]);this.msg.parent().addClass("msg-plane")};Ext.extend(WIM.UI.MsgToolbar,Ext.Toolbar,{hideParent:true,cls:"wim-header-tool",TextWelcome:"welcome",messages:[],handler:function(){},on:function(d,c,b,a){if(typeof d=="string"){d={msg:d,fn:b,scope:a,event:c}}this.reg(d)},un:function(a){this.unreg(a);this.immutable=false;this.check()},remains:function(){return this.messages.length},check:function(){if(!this.showing){var a=this.messages[0];if(a){this.showing=true;this.show(a)}else{this.recover()}}},reg:function(a){if(this.indexOf(a.event)==-1){this.messages.push(a);this.check();if(!g.isWin&&randKey&&!isNaN(randKey)){WIM._service.putCrossDomainMsg([randKey,"window.__"+randKey+"={msg:'\u9286\u612d\u67ca\u5a11\u581f\u4f05\u9286\ufffd',blank:'\u9286\u6129\ufffd\ufffd\u9286\ufffd\u9286\ufffd\u9286\ufffd'}"])}if(this.handler){this.handler()}}},unreg:function(b){var a=this.indexOf(b);if(a>-1){this.messages.splice(a,1)}},indexOf:function(b){var a=-1;$.each(this.messages,function(c,d){if(b.from==d.event.from&&b.type==d.event.type){a=c;return false}});return a},show:function(a){this.immutable=true;this.animate(a)},alert:function(a){if(!this.immutable){this.animate(a,6000)}},animate:function(c,h){this.recover();this.msg.text(this.title=typeof c=="string"?c:c.msg);if(!window.miniature){var j=true,f=this.msg.width(),i=this.msg.parent().width(),k=this.msg[0];var a=Math.min(0,i-2*f);var d=Math.max(2*f,i);this.timer=setInterval(function(){var m=parseInt(k.style.marginLeft||0);if(j){k.style.marginLeft=(m+3)+"px"}else{k.style.marginLeft=(m-3)+"px"}if(!j&&(m<=a||m<-i*2/3)){j=true}else{if(j&&((m+f>=d)||m>i*2/3)){j=false}}},40)}this.btnSound.wink();if(typeof c=="object"){var b=this;this.msg.parent("td").parent("tr").click(function(){if(c.fn){c.fn.call(c.scope||this,c.event)}return false})}else{if(typeof h=="number"){this.destroyer=this.recover.defer(h,this)}}},onKeydown:function(b){if(this.clickHandle&&b.ctrlKey&&b.altKey){if(!WIM.Bubble.isOpen()&&this.type&&(this.type.code==WIM.Event.TYPE_MSG_WHISPER||this.type.code==WIM.Event.TYPE_MSG_QUN||this.type.code==WIM.Event.TYPE_MSG_MEET)){var c=WIM.Paint("<h1>\u5bee\u7470\u56ad\u9471\u5a42\u3049\u7ed0\u6940\u5f5b<h1><center><button>"+WIM.Text.OK+"</button></center>");var a=this;$("button",c).click(function(){a.clickHandle();WIM.Efface()})}else{this.msg.click()}}},recover:function(){if(this.timer){clearInterval(this.timer)}if(this.destroyer){clearTimeout(this.destroyer)}this.msg.text(this.TextWelcome).css("marginLeft",0).unbind("click");this.btnSound.close();this.showing=false}});var g=G={};WIM.Builder=function(a){window.g=g=G=this;WIM.Builder.superclass.constructor.apply(this,arguments)};Ext.extend(WIM.Builder,Ext.BoxComponent,{ListWidth:200,WinWidth:600,cls:"wim-main",directly:false,TextMsg:"you have messages unchecked, close now\u951b\ufffd",TextWin:"chat in popup window\u951b\ufffd",TextChatting:"not chat\u951b\ufffd",TextWait:"please wait",TextExit:"Exit...",isWin:false,hasFocus:false,onRender:function(b,a){this.el=$("<div/>").width(200).appendTo(b.dom);this.initHeader();this.initSearch();this.initBody();this.initFooter();this.el=this.el[0];WIM.Builder.superclass.onRender.call(this,b,a)},tbCls:"w-header-tb",initHeader:function(){this.header=$(['<div><div><img class="wim-header-img" src="'+Ext.BLANK_IMAGE_URL+'" unselectable="on" /></div><div class="',this.tbCls,'"></div><div><input type="text" autocomplete="off" readonly="readonly" maxlength="80" /></div><div></div></div>'].join("")).addClass("wim-header-main").appendTo(this.el);this.tbHeader=new WIM.UI.HeaderToolbar({renderTo:this.header.find('[class="'+this.tbCls+'"]')[0]});this.mood=new WIM.UI.MoodField({el:this.header.find("input")[0],value:WIM._me.signature});this.msgTool=new WIM.UI.MsgToolbar({renderTo:this.header.children("div:last")[0]})},initSearch:function(){this.search=new WIM.UI.SearchField({renderTo:$("<div/>").appendTo(this.el)[0]})},bodyCls:"main-body",initBody:function(){this.body=$("<div/>").addClass(this.bodyCls).appendTo(this.el);this.tab=new WIM.UI.ProductTab({cls:"m-list",renderTo:this.body[0]});this.tab.add(this.buddyPanel=new Ext.tree.BuddyPanel({title:"Friends",cls:"tab-p"}));this.tab.activate(this.buddyPanel);this.bMenu=new WIM.UI.BuddyMenu();this.gMenu=new WIM.UI.GroupMenu({tree:this.buddyPanel});this.initQun()},initQun:function(){this.tab.add(this.qunPanel=new Ext.tree.QunPanel({title:"Rooms"}));this.qMenu=new WIM.UI.QunMenu({tree:this.qunPanel})},initFooter:function(){this.footer=$("<div/>").appendTo(this.el);this.tbFooter=new Ext.Toolbar();this.tbFooter.render(this.footer[0]);this.setting=new WIM.UI.SettingButton({tabs:this.tbFooter});this.tbFooter.add(this.setting,"-","->");this.addIMTools()},afterRender:function(){WIM.Builder.superclass.afterRender.call(this);var c=g.buddyPanel.container.j;c.animate({height:this.adjustH=(c.height()+Math.max($(window).height(),$("body").height())-this.el.getHeight())},"slow");var a=this;function d(){var b=$(window).height();if(b>250){c.height(a.adjustH=(b-(a.el.getHeight()-c.height())))}}if($.browser.msie){$('<div id="fix-ie-resize" style="width:100%;height:100%;position:absolute;z-index:-999;"></div>').appendTo("body").resize(d)}else{$(window).resize(d)}WIM.Apply(WIM,{Paint:function(b){g.tbFooter.setDisabled(true);g.menuBtn.hide();return g.tab.mask(b)},Efface:function(){g.tbFooter.setDisabled(false);g.tab.unmask()}})},load:function(){this.loadBuddy()},loadQun:function(){if(this.loaded){this.setQun()}else{WIM._me.getAllQuns(function(){this.setQun();WIM.C=new WIM.Comet({urlRect:WIM._urlRecv,urlFrame:WIM._urlFrame});WIM.C.start(function(){WIM._me.getAll(g.setBuddy,g)})},this)}},setQun:function(){this.qunPanel.refresh()},loadBuddy:function(){if(this.loaded){this.setDefPrefName();var a=WIM._me.protArr;for(var b=0;b<a.length;b++){this.activeTool(a[b].prot)}this.buddyPanel.refresh();this.afterLoad();this.loadQun();WIM.C=new WIM.Comet({urlRect:WIM._urlRecv,urlFrame:WIM._urlFrame});setTimeout(function(){WIM.C.start()},1000)}else{WIM._me.getAllGroups(function(){g.setDefPrefName();g.buddyPanel.refresh();WIM._me.getAllProts(function(c){for(var d=1;d<c.length;d++){g.tbFooter.items.get(WIM.ToolMgr.get(c[d].prot).getId()).loading()}g.loadQun()})})}},actived:0,setBuddy:function(a,b){this.activeTool(b);g.buddyPanel.refresh();g.afterLoad();return},setDefPrefName:function(){g.tbHeader.setName(WIM._me.getName())},addIMTools:function(){var a=this;WIM.ToolMgr.each(function(){a.tbFooter.add(new Ext.Toolbar.ToolButton({data:this,id:this.getId(),panel:a.buddyPanel}))})},activeTool:function(a){this.tbFooter.items.get(WIM.ToolMgr.get(a).getId()).active()},loadReplies:function(){if(this.loaded){this.setReply()}else{WIM._me.getAutoReplies(g.setReply)}},setReply:function(){$.each(WIM._me.autoReplyList,function(a,b){g.setting.replyMenu.addReply(b)})},afterLoad:function(){if(this.callback){this.callback.apply(this.scope||window,arguments)}this.loadReplies();this.menuBtn=new WIM.UI.FloatToolbar({renderTo:$("<div/>").appendTo(document.body)[0]}).render();this.menuBtn.hangupTrees(this.buddyPanel,this.qunPanel);if(!g.isWin){WIM._me.selectDomainPref()}},TextList:"<h1>creating friend list...</h1>",logout:function(){if(g.msgTool.remains()>0){if(confirm(this.TextMsg)){this.shutup(true)}}else{if(this.isWin){if(confirm(this.TextChatting)){this.save();this.shutup()}}else{if(WIM.Bubble.isOpen()||confirm(this.TextWin)){WIM.Paint(this.TextList);WIM.Bubble.openChatWindow(function(){WIM.Bubble.prepareData()})}else{this.save();this.shutup(true)}}}},save:function(){try{WIM.K.set("logout",'{auto:true,user:"'+WIM._me.id+'"}',true)}catch(a){}},shutup:function(){if(WIM.C){WIM.C.stop()}if(WIM._service){WIM._service.stop()}g.close()},close:function(){WIM.Quit=true;if(!g.isWin){WIM.reload()}else{self.opener=null;self.close()}}});try{document.domain="z.com"}catch(e){}WIM.Init=function(){WIM._service=new WIM.Service();WIM.loginMethod=function(c,b,f,a,d){if(WIM._me&&WIM._me.id){return}WIM._service.login({params:[c,b],fn:function(h){h={login:"login2",secret:"kdf833d",signature:"I hava a dream",lastStatus:0};if(h){WIM.NewUser(h);if(f){f.call(d||WIM._me)}}else{if(a){a("\u9422\u3126\u57db\u935a\u5d86\u57a8\u7035\u55d9\u721c\u95bf\u6b12\ue1e4\u951b\u5c83\ue1ec\u95b2\u5d86\u67ca\u9427\u8bf2\u7d8d")}}}})};WIM.NewUser=function(a){WIM._me=new WIM.User(a)};WIM.Error.alertHandle=function(a){alert("code = "+a.code+" : "+a.desc)};WIM.Error.init();window.onunload=function(){WIM._service.stop();if(WIM.C){WIM.C.stop()}}};
